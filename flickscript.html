<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <link rel="icon" type="image/png" href="favicon.png">


  <link rel="stylesheet" href="lib/codemirror.css">
  <link rel="stylesheet" href="theme/darcula.css">
  <link rel="stylesheet" href="addon/lint/lint.css">

  <script src="lib/codemirror.js"></script>
  <script src="addon/mode/simple.js"></script>
  <script src="addon/lint/lint.js"></script>

  <style type="text/css">
    .CodeMirror {
      border: 1px solid black;
      margin-bottom: 1em;
    }

    dt {
      text-indent: -2em;
      padding-left: 2em;
      margin-top: 1em;
    }

    dd {
      margin-left: 1.5em;
      margin-bottom: 1em;
    }

    dt {
      margin-top: 1em;
    }

    .enabledlayer {}

    .disabledlayer {
      color: gray;
    }
  </style>

  <script src="FileSaver.js"></script>
  <script type="text/javascript">


    var colorIndex = getRandomInt(7, 16);

    var interpreterActive = false;

    var trace = console.log

    var logError = function (s, orig_line, orig_line_number) {
      window.alert("ERROR" + "\n" + "Line " + orig_line_number + " : " + s + "\n" + orig_line);
    }


    function setVisualEnabledIndicator() {
      for (var i = 0; i < pages; i++) {
        layerNameElem[i].setAttribute("class", (enabled[i] * visibleCanvasses[i]) === 1 ? "enabledlayer" : "disabledlayer");;
      }
    }

    function leavePlayMode() {
      for (var i = 0; i < pages; i++) {
        enabled[i] = 1;
      }
      setVisualEnabledIndicator();
      updateLayerLabels();
      updateCursor();
    }

    function enable(l) {
      if (interpreterActive) {
        console.log("enabling layer " + (l + 1));
        enabled[l] = true;
        setVisualEnabledIndicator();
      }
    }

    function disable(l) {
      if (interpreterActive) {
        console.log("disabling layer " + (l + 1));
        enabled[l] = false;
        setVisualEnabledIndicator();
      }
    }


    function setLayerVisible(index) {
      // for (var i=0;i<pages;i++){
      //     if (gameState.visibleCanvasses[i]===1 && gameState.colors[i]===gameState.colors[index]){
      //         gameState.visibleCanvasses[i]=0;
      //     }
      // }
      if (interpreterActive) {
        enabled[index] = 1;
        visibleCanvasses[index] = 1;
        setVisualEnabledIndicator();
      }
    }



    function setLayerInvisible(index) {

      if (interpreterActive) {
        enabled[index] = 0;
        visibleCanvasses[index] = 0;
        setVisualEnabledIndicator();
      }
    }

    function show(l) {
      if (interpreterActive) {
        console.log("showing layer " + (l + 1));
        setLayerVisible(l)
      }

    }

    function hide(l) {

      if (interpreterActive) {
        console.log("hiding layer " + (l + 1));
        setLayerInvisible(l)
      }
    }

    function reset() {
      if (interpreterActive) {
        loadState(gamecode);
      }
    }

    var gamecode = null;


    var gameState = null;//just used for interpreter

    /***************/
    /* START SCRIPT*/
    /***************/

    var commands = ["enable", "disable", "show", "hide"];

    function isNumeric(n) {
      return !isNaN(parseFloat(n)) && isFinite(n);
    }

    function calculateFrameReference(t, frameNumber, orig_line, orig_line_number) {
      if (t.match("this")) {
        return frameNumber;
      } else if (t.match(/^[\+\-]?[\d]+$/) === null) {
        logError("malformed thing given '" + t + "'.  Expected a reference to a frame, like '4' or '+2' or '-1' or 'this'", orig_line, orig_line_number)
        return frameNumber;
      }
      var target = frameNumber;
      if (!isNumeric(t)) {
        logError(`${t} isn't a frame reference. I'm expecting a one here, something like '2' or '-3' or '+4' or 'this'.`, orig_line, orig_line_number);
      }

      if (t[0] === "+" || t[0] === "-") {
        target += parseInt(t)
      } else {
        target = parseInt(t) - 1;
      }

      if (target < 0 || target >= pages) {
        logError("trying to access frame number " + (target + 1) + ", which is out of range", orig_line, orig_line_number);
      }
      return target;
    }


    //assumes line already nicely formatted
    function runCommandLine(line, frameNumber, orig_line, orig_line_number) {
      var tokens = line.split(/\s+/);
      var command = tokens[0];

      if (tokens.length <= 1) {
        logError(`command ${command} requires a parameter - like "${command} 3" or "${command} -1"`, orig_line, orig_line_number)
        return;
      }

      for (var i = 1; i < tokens.length; i++) {
        var t = tokens[i];
        var target = calculateFrameReference(t, frameNumber, orig_line, orig_line_number)

        switch (command) {
          case "enable":
            {
              enable(target);
              break;
            }
          case "disable":
            {
              disable(target);
              break;
            }
          case "show":
            {
              show(target);
              break;
            }
          case "hide":
            {
              hide(target);
              break;
            }
        }
      }
    }


    function evaluateIf(line, frameNumber, orig_line, orig_line_number) {

      //i know there's an if at the start and a then at the end
      var substr = line.substr(2, line.length - 6).trim();
      var tokens = substr.split(",").map(t => t.trim());
      if (tokens.length === 0) {
        logError("if statement must have arguments, e.g. 'IF 1, 3 THEN' ", orig_line, orig_line_number)
        return true;
      }

      var truthfulness = true;
      if (interpreterActive) {
        trace("evaluatig truthfuless")
      }
      for (var i = 0; i < tokens.length; i++) {
        var t = tokens[i];
        var s = t.split(/\s+/);
        var fr = s[s.length - 1];
        var target = calculateFrameReference(fr, frameNumber, orig_line, orig_line_number);
        if (s[0] === "not") {
          trace("\t" + t)
          truthfulness = truthfulness && visibleCanvasses[target] === 0;
        } else {
          trace("\t" + t)
          truthfulness = truthfulness && visibleCanvasses[target] === 1;
        }
      }
      if (interpreterActive) {
        trace("T = " + truthfulness);
      }
      return truthfulness;
    }

    function runScript(s, frameNumber) {
      trace("running script")
      var lines = s.split('\n');
      for (var i = 0; i < lines.length; i++) {
        var orig_line = lines[i];
        var line = orig_line.split(";", 1)[0].trim().toLowerCase();
        if (line === "") {
          continue;
        }
        var tokens = line.split(/\s+/);
        if (commands.indexOf(tokens[0]) >= 0) {
          runCommandLine(line, frameNumber, orig_line, i)
        }
        else if (tokens[0] === "if") {
          if (tokens[tokens.length - 1] !== "then") {
            logError("IF statement must have a THEN at the end - of the form like 'IF 3, 4, +2 THEN'" + orig_line, orig_line, i);
          } else if (evaluateIf(line, frameNumber, orig_line, i)) {
            //keep going as usual
          }
          else {
            //skip ahead until "else" or "end"
            outloop:
            {
              var depth = 1;
              for (var j = i + 1; j < lines.length; j++) {
                var line2 = lines[j]
                var firsttokens = line2.trim().split(";", 1)[0].split(/\s+/, 1);
                if (firsttokens.length > 0) {
                  var firsttoken = firsttokens[0];
                  if (firsttoken === "if") {
                    depth++;
                  }
                  else if ((depth == 1 && firsttoken === "else") || firsttoken === "end") {
                    depth--;
                    if (depth === 0) {
                      i = j;
                      break outloop;
                    }
                  }
                }
              }
              i = lines.length;
            }
          }
          //no nested if statements allowed
        } else if (tokens[0] === "else") {
          //skip ahead to end
          outloop:
          {
            var depth = 1;
            for (var j = i + 1; j < lines.length; j++) {
              var line2 = lines[j]
              var firsttokens = line2.trim().split(";", 1)[0].split(/\s+/, 1);
              if (firsttokens.length > 0) {
                var firsttoken = firsttokens[0]
                if (firsttoken === "if") {
                  depth++;
                }
                if (firsttoken === "end") {
                  depth--;
                  if (depth === 0) {
                    i = j;
                    break outloop;
                  }
                }
              }
            }
            i = lines.length;
          }
        } else if (tokens[0] === "end") {
          //do nothing
        } else if (tokens[0] === "reset") {
          reset();
        } else {
          logError("ERROR here " + orig_line, orig_line, i);
        }
      }
    }

    /**************/
    /* END SCRIPT */
    /**************/

    function DoLint(text, frameNumber) {
      var oldLogError = logError;

      var errorList = [];
      logError = function (s, orig_line, orig_line_number) {
        errorList.push({
          from: CodeMirror.Pos(orig_line_number),
          to: CodeMirror.Pos(orig_line_number),
          message: s,
          severity: "error"
        })
      }
      runScript(text, frameNumber);

      logError = oldLogError;
      return errorList;
    }

    CodeMirror.keyMap.default["Shift-Tab"] = "indentLess";
    CodeMirror.keyMap.default["Tab"] = "indentMore";

    CodeMirror.registerHelper("lint", "flickgamescript", function (text, options) {
      var found = DoLint(text, canvasIndex);
      return found;
    });

    var contexts = new Array();
    var version = "0.1";
    var gameLink = "www.flickgame.org/flickscript.html"
    var canvasIndex = 0;

    var canvasses = new Array();
    var scripts = new Array();
    var visibleCanvasses = new Array();
    var enabled = new Array();

    var shareLinkInner = null;
    var nosave = false;
    var editor = null;

    //arne
    var colorPalette = [
      "#000000",
      "#9D9D9D",
      "#FFFFFF",
      "#BE2633",
      "#E06F8B",
      "#493C2B",
      "#A46422",
      "#EB8931",
      "#F7E26B",
      "#2F484E",
      "#44891A",
      "#A3CE27",
      "#1B2632",
      "#005784",
      "#31A2F2",
      "#B2DCEF"
    ];


    //dawnbringer
    //http://www.pixeljoint.com/forum/forum_posts.asp?TID=12795
    // var colorPalette = [
    //           "#140c1c",
    //           "#442434",
    //           "#30346d",
    //           "#4e4a4e",
    //           "#854c30",
    //           "#346524",
    //           "#d04648",
    //           "#757161",
    //           "#597dce",
    //           "#d27d2c",
    //           "#8595a1",
    //           "#6daa2c",
    //           "#d2aa99",
    //           "#6dc2ca",
    //           "#dad45e",
    //           "#deeed6"
    //           ];

    /*
     //spectrum 
         var colorPalette = [
                 "#000000",
                 "#888888",
                 "#CDCDCD",
                 "#FFFFFF",
                 "#0000CD",
                 "#0000FF",
                 "#CD0000",
                 "#FF0000",
                 "#CD00CD",
                 "#FF00FF",
                 "#00CD00",
                 "#00FF00",
                 "#00CDCD",
                 "#00FFFF",
                 "#CDCD00",
                 "#FFFF00"
                 ];
     */
    var colorElem = new Array();
    var layerElem = new Array();
    var layerNameElem = new Array();
    var visibilityElem = new Array();

    var aurl = document.createElement('a');

    function qualifyURL(url) {
      aurl.href = url;
      return aurl.href;
    }


    var radiusElem = new Array();
    var handElem = null;
    var thumbnailCanvas = new Array();
    var thumbnailContext = new Array();

    var standalone_HTML_String = "";

    var clientStandaloneRequest = new XMLHttpRequest();

    clientStandaloneRequest.open('GET', 'flickscript_play.html');
    clientStandaloneRequest.onreadystatechange = function () {

      if (clientStandaloneRequest.readyState != 4) {
        return;
      }
      standalone_HTML_String = clientStandaloneRequest.responseText;
    }
    clientStandaloneRequest.send();


    var get_blob = function () {
      return self.Blob;
    }

    function buildStandalone(sourceCode) {
      if (standalone_HTML_String.length === 0) {
        alert("Can't export yet - still downloading html template.", true);
        return;
      }
      sourceCode = encodeURI(sourceCode);
      var htmlString = standalone_HTML_String.concat("");


      htmlString = "<!--Save as html file-->\n" + htmlString;
      htmlString = htmlString.replace(/__EMBED__/g, sourceCode);

      var BB = get_blob();
      var blob = new BB([htmlString], {
        type: "text/html;charset=utf-8"
      });
      saveAs(blob, "flickscript_game.html");
    }

    function exportClick() {
      var embedDat = stateToString();
      buildStandalone(embedDat);
    }

    function importClick() {
      var reader = new FileReader();

      reader.onload = function (e) {
        var text = reader.result;
      }

      reader.readAsText(file, encoding);
    }



    OAUTH_CLIENT_ID = "eb2aad12c63aec0136b1";


    function getAuthURL() {
      var randomState = window.btoa(Array.prototype.map.call(
        window.crypto.getRandomValues(new Uint8Array(24)),
        function (x) {
          return String.fromCharCode(x);
        }).join(""));

      var authUrl = "https://github.com/login/oauth/authorize" +
        "?client_id=" + OAUTH_CLIENT_ID +
        "&scope=gist" +
        "&state=" + randomState +
        "&allow_signup=true";

      return authUrl;
    }

    function printUnauthorized() {

      var authUrl = getAuthURL();
      var toPrint = "<a target=\"_blank\" href=\"" + authUrl + "\">Log in with Github to share</a><br>";

      var shareLink = document.getElementById("shareLink");
      shareLink.innerHTML = toPrint;
      shareLinkInner = null;
    }



    function githubLogOut() {
      window.localStorage.removeItem("oauth_access_token");
      var authUrl = getAuthURL();
      var toPrint = "Logged out of Github.<br>";
      var shareLink = document.getElementById("shareLink");
      shareLink.innerHTML = toPrint;
      shareLinkInner = null;
    }


    function shareClick() {
      var oauthAccessToken = window.localStorage.getItem("oauth_access_token");
      if (typeof oauthAccessToken !== "string") {
        // Generates 32 letters of random data, like "liVsr/e+luK9tC02fUob75zEKaL4VpQn".
        printUnauthorized();
        return;
      }


      var str = stateToString();

      var gistToCreate = {
        "description": "flickgame",
        "public": true,
        "files": {
          "readme.txt": {
            "content": "A game made with www.flickgame.org/flickscript.html.  You can import game.txt there to play the game.  Uh, too lazy to describe - HMU at analytic@gmail.com if you want to know how (basically just use the gist ID in the url like other flickgames do...) "
          },
          "game.txt": {
            "content": str
          }
        }
      };

      var githubURL = 'https://api.github.com/gists';
      var githubHTTPClient = new XMLHttpRequest();
      githubHTTPClient.open('POST', githubURL);
      githubHTTPClient.onreadystatechange = function () {
        var errorCount = 0;
        if (githubHTTPClient.readyState != 4) {
          return;
        }
        var result = JSON.parse(githubHTTPClient.responseText);
        if (githubHTTPClient.status === 403) {
          errorCount++;
          alert(result.message);
        } else if (githubHTTPClient.status !== 200 && githubHTTPClient.status !== 201) {

          if (githubHTTPClient.statusText === "Unauthorized") {
            alert("Authorization check failed.  You have to log back into GitHub (or give it permission again or something).");
            window.localStorage.removeItem("oauth_access_token");
          } else {
            alert("HTTP Error " + githubHTTPClient.status + ' - ' + githubHTTPClient.statusText);
          }

          printUnauthorized();
        } else if (githubHTTPClient.status !== 200 && githubHTTPClient.status !== 201) {
          errorCount++;
          alert("HTTP Error " + githubHTTPClient.status + ' - ' + githubHTTPClient.statusText);
        } else {
          var id = result.id;
          var url = "flickscript_play.html?p=" + id;
          url = qualifyURL(url);

          var editurl = "flickscript.html?hack=" + id;
          editurl = qualifyURL(editurl);
          var sourceCodeLink = "link to source code:<br><a href=\"" + editurl + "\">" + editurl + "</a>";

          var shareLink = document.getElementById("shareLink");
          shareLink.innerHTML = "<a target=\"_blank\" href=\"" + url + "\">&#8627;" + id + "</a><br>" +
            '(<a onclick="githubLogOut();"  href="javascript:void(0);">log out of GitHub</a>)<br>';
          shareLinkInner = shareLink.childNodes[0];

          if (errorCount > 0) {
            alert("Cannot link directly to playable game, because there are errors.", true);
          } else {

          }


        }
      }
      githubHTTPClient.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      githubHTTPClient.setRequestHeader("Authorization", "token " + oauthAccessToken);
      var stringifiedGist = JSON.stringify(gistToCreate);
      githubHTTPClient.send(stringifiedGist);
      lastDownTarget = visibleCanvas;
    }


    function RLE_encode(input) {
      var encoding = [];
      var prev, count, i;
      for (count = 1, prev = input[0], i = 1; i < input.length; i++) {
        if (input[i] != prev) {
          encoding.push(count);
          encoding.push(prev);
          count = 1;
          prev = input[i];
        }
        else
          count++;
      }
      encoding.push(count);
      encoding.push(prev);
      return encoding;
    }


    function stateToString() {
      var state = new Object();
      state.canvasIndex = canvasIndex;
      state.gameLink = gameLink;
      state.canvasses = new Array();
      state.visibleCanvasses = new Array();
      state.enabled = new Array();
      state.scripts = [];
      for (var i = 0; i < pages; i++) {
        var canvas = canvasses[i];
        var s = "";
        for (var j = 0; j < width * height; j++) {
          s += canvas[j].toString(17);
        }
        var pairs = RLE_encode(s);
        state.canvasses.push(pairs);
        state.visibleCanvasses.push(visibleCanvasses[i])
        state.scripts.push(scripts[i].trim())
        state.enabled.push(1)
      }
      var result = JSON.stringify(state);
      return result;
    }

    function stringToState(str) {
      var state = JSON.parse(str);
      gameLink = state.gameLink;
      canvasIndex = state.canvasIndex;
      canvasses = new Array();
      visibleCanvasses = new Array();


      for (var k = 0; k < state.canvasses.length; k++) {
        var s = state.canvasses[k];
        var ar = new Uint8Array(width * height);
        var index = 0;
        for (var i = 0; i < s.length; i += 2) {
          var count = s[i];
          var ch = s[i + 1];
          for (var j = 0; j < count; j++) {
            ar[index] = parseInt(ch, 17);
            index++;
          }
        }
        canvasses.push(ar);
        visibleCanvasses.push(parseInt(state.visibleCanvasses[k]))
      }

      scripts = state.scripts;

      setVisuals(true);
      setVisibilityIcons();
      setLayer(canvasIndex + 1);
    }

    document.addEventListener("keydown", press);
    document.addEventListener("keyup", release);

    var clipboard = null;

    var savedString;

    function press(evt) {
      evt = evt || window.event;

      if (evt.target.nodeName == "TEXTAREA") {
        return;
      }
      /*
         if (evt.keyCode==83){//S(ave)
         savedString = stateToString();
         } else if (evt.keyCode==76){//L(oad)
         stringToState(savedString);
         setVisuals();
         setLayer(canvasIndex+1); 
         } */
      if (evt.keyCode === 67) { //c
        clipboard = {
          image: JSON.stringify(canvasses[canvasIndex]),
          script: scripts[canvasIndex]
        };
      } else if (evt.keyCode === 88) { //x
        clipboard = {
          image: JSON.stringify(canvasses[canvasIndex]),
          script: scripts[canvasIndex]
        };
        clearPalette();
        scripts[canvasIndex] = "";
        editor.setValue("");
      } else if (evt.keyCode === 86) { //v
        if (clipboard !== null) {
          preserveUndoState();
          var ar = JSON.parse(clipboard.image);
          var arui8 = new Uint8Array(width * height);
          for (var i = 0; i < width * height; i++) {
            arui8[i] = ar[i];
          }
          canvasses[canvasIndex] = arui8;
          scripts[canvasIndex] = clipboard.script;
          editor.setValue(scripts[canvasIndex]);
          setVisuals();
        }
      } else if (evt.keyCode === 189 || evt.keyCode === 173) { //-
        if (radius === 3) {
          setRadius(1);
        } else if (radius === 5) {
          setRadius(3);
        } else if (radius === 7) {
          setRadius(5);
        } else if (radius === 9) {
          setRadius(7);
        } else if (radius === 11) {
          setRadius(9);
        } else if (radius === 13) {
          setRadius(11);
        } else if (radius === 16) {
          setRadius(13);
        }
      } else if (evt.keyCode === 187 || evt.keyCode === 61) { //+
        if (radius === 0) {
          setRadius(1);
        } else if (radius === 1) {
          setRadius(3);
        } else if (radius === 3) {
          setRadius(5);
        } else if (radius === 5) {
          setRadius(7);
        } else if (radius === 7) {
          setRadius(9);
        } else if (radius === 9) {
          setRadius(11);
        } else if (radius === 11) {
          setRadius(13);
        } else if (radius === 13) {
          setRadius(16);
        }
      } else if (evt.keyCode === 90) { //z
        if (undoList.length > 0) {
          var dat = undoList.pop();
          nosave = true;
          if ("fullstore" in dat) {
            stringToState(dat.fullstore);
            setVisuals(true);
            setLayer(canvasIndex + 1);
          } else {
            canvasses[dat.canvasIndex] = dat.canvasDat;
            scripts[dat.canvasIndex] = dat.script;
            visibleCanvasses = dat.visibleCanvasses.slice();
            setLayer(dat.canvasIndex + 1);

            if (shareLinkInner !== null) {
              shareLinkInner.style.color = "gray";
            }
          }
          nosave = false;
          setVisibilityIcons();
        }
      }

      if (evt.keyCode === 91 || evt.keyCode === 16 || evt.keyCode === 17) {
        if (drawing === 1) {
          drawing = -1;
        }
      }
    }


    function release(evt) {
      evt = evt || window.event;

      if (evt.target.nodeName == "TEXTAREA") {
        return;
      }


      if (evt.keyCode === 91 || evt.keyCode == 16 || evt.keyCode == 17) {
        if (drawing === -1) {
          drawing = 1;
        }
      }
    }

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min)) + min;
    }
    var thumbwidth = 20;
    var thumbheight = 10;
    var width = 200;
    var height = 100;
    var zoomFactor = 4;
    var radius = 5;
    var pages = 50;

    var visibleCanvas;
    var visibleContext;
    var linkInput;
    var id;
    var id_d;

    var lastX = -1;
    var lastY = -1;

    var bucketElem;

    function linkChange(newLink) {
      gameLink = newLink;
    }

    function clearPalette() {
      preserveUndoState();
      var canvas = canvasses[canvasIndex];
      for (var i = 0; i < width * height; i++) {
        canvas[i] = 0;
      }

      setVisuals();
    }


    function setToolsSelection() {
      handElem.setAttribute("class", "radius");
      bucketElem.setAttribute("class", "radius");
      for (var i = 0; i < 16; i++) {
        if (radiusElem[i] !== null) {
          radiusElem[i].setAttribute("class", "radius");
        }
      }

      if (handMode) {
        handElem.setAttribute("class", "radius selected");
      } else {

        if (radius > 0) {
          radiusElem[radius - 1].setAttribute("class", "radius selected");
        } else {
          bucketElem.setAttribute("class", "radius selected");
        }
      }
    }

    var handMode = false;
    function setHand() {
      handMode = true;
      gamecode = stateToString();
      reset();

      for (var i = 0; i < pages; i++) {
        enabled[i] = 1;
        visibleCanvasses[i] = (i === 0) ? 1 : 0;
      }
      gamecode = stateToString();


      interpreterActive = true;
      runScript(scripts[0], 0)
      interpreterActive = false;

      setToolsSelection();
      updateLayerLabels();
      setVisualEnabledIndicator();
      setVisuals();
    }

    function rewind() {
      reset();
      setToolsSelection();
      updateLayerLabels();
      setVisualEnabledIndicator();
      setVisuals();
    }

    function setRadius(newRadius) {
      handMode = false;
      leavePlayMode();
      radius = newRadius;
      setToolsSelection();
    }


    function loadState(code) {
      gamecode = code;
      state = JSON.parse(code);
      enabled = []
      setVisualEnabledIndicator();
      for (var i = 0; i < pages; i++) {
        visibleCanvasses[i] = i === 0 ? 1 : 0;
        enabled[i] = 1;
      }
      setLayer(1);
    }

    function setColor(newColorIndex) {
      colorIndex = newColorIndex;
      for (var i = 0; i < 16; i++) {
        if (colorElem[i] !== null) {
          colorElem[i].setAttribute("class", "unselected");
        }
      }
      colorElem[colorIndex].setAttribute("class", "selected");
    }

    function setVisibilityIcons() {
      for (var i = 0; i < pages; i++) {
        if (visibleCanvasses[i] === 0) {
          visibilityElem[i].src = "eye2.png";
        } else {
          visibilityElem[i].src = "eye.png";
        }
      }
    }

    function toggleLayerVisible(index) {
      if (index === canvasIndex) {
        visibleCanvasses[index] = 0;
        visibilityElem[index].src = "eye2.png"
        //first look for lower layer to select
        for (var i = index - 1; i >= 0; i--) {
          if (visibleCanvasses[i] === 1) {
            setLayer(i + 1);
            return;
          }
        }

        for (var i = index + 1; i < pages; i++) {
          if (visibleCanvasses[i] === 1) {
            setLayer(i + 1);
            return;
          }
        }

        //fallback: literally no layers visible, just enable layer zero 
        setLayer(1);
        return;
      }
      visibleCanvasses[index] = 1 - visibleCanvasses[index];
      if (visibleCanvasses[index] === 0) {
        visibilityElem[index].src = "eye2.png";
      } else {
        visibilityElem[index].src = "eye.png";
      }
      setVisuals();
    }

    function setLayerVisible(index) {
      // for (var i = 0; i < pages; i++) {
      //     if (visibleCanvasses[i] === 1 && colors[i] === colors[index]) {

      //         visibilityElem[i].src = "eye2.png";
      //         visibleCanvasses[i] = 0;
      //     }
      // }
      enabled[index] = 1;
      visibleCanvasses[index] = 1;
      visibilityElem[index].src = "eye.png";
    }

    function updateLayerLabels() {
      for (var i = 0; i < pages; i++) {
        if (layerElem[i] !== null) {
          layerElem[i].setAttribute("class", "layerItem");
        }
      }
      if (!handMode) {
        layerElem[canvasIndex].setAttribute("class", "layerItem selectedItem");
      }
    }
    //TAKES INDICES STARTING FROM 1
    function setLayer(newCanvasIndex) {

      setLayerVisible(newCanvasIndex - 1)
      canvasIndex = newCanvasIndex - 1;
      updateLayerLabels();
      editor.setValue(scripts[canvasIndex]);
      setVisuals();
    }

    function trace(s) {
      window.console.log(s);
    }

    function onTextAreaChange() {
      var s = editor.getValue();
      scripts[canvasIndex] = s;
    }

    function createBlankDoc() {
      for (var i = 0; i < pages; i++) {
        canvasses[i] = new Uint8Array(width * height);
      }
      canvasIndex = 0;
      scripts = []
      visibleCanvasses = []
      for (var i = 0; i < pages; i++) {
        scripts.push("")
        visibleCanvasses.push(0);
      }
      scripts[0] = `;
;silly sample game

;the first frame is not like others - the script is executed immediately on load`
      setLayer(1);
    }

    function newDoc() {
      preserveUndoState(true);
      createBlankDoc();
      setVisuals(true);
      setVisibilityIcons();
    }

    function canvasContextMenu(e) {
      e.preventDefault();
      return false;
    };

    function init() {

      CodeMirror.defineSimpleMode("flickgamescript", {
        // The start state contains the rules that are intially used
        start: [{
          regex: /;.*/,
          token: "comment"
        },
        {
          regex: /\bthis\b/i,
          token: "number"
        },
        {
          regex: /\b(if|then|end|else)\b/i,
          token: "keyword"
        },
        {
          regex: /\bnot\b/,
          token: "atom"
        },
        {
          regex: /[\+\-][\d]/i,
          token: "number"
        },
        {
          regex: /\b[\d]+\b/i,
          token: "number"
        },
        {
          regex: /[\+\-]/i,
          token: "number"
        },
        {
          regex: /\b(enable|disable|show|hide|reset)\b/i,
          token: "variable"
        },
        {
          regex: /,/i,
          token: "variable"
        },
        ],
        meta: {
          lineComment: ";"
        }
      });




      editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        lineNumbers: true,
        matchBrackets: true,
        continueComments: "Enter",
        mode: "flickgamescript",
        extraKeys: {
          "Ctrl-Q": "toggleComment"
        },
        theme: "darcula",
        lineWrapping: true,
        gutters: ["CodeMirror-lint-markers"],
        lint: true
      });
      editor.setSize(708, 258);

      editor.on("change", onTextAreaChange)


      nosave = true;

      linkInput = document.getElementById("linkInput");
      linkInput.value = gameLink;


      radii = new Array();
      for (var i = 0; i < 16; i++) {
        elem = document.getElementById("radius_" + (i + 1));
        radiusElem[i] = elem;

      }
      handElem = document.getElementById("sethand");

      for (var i = 0; i < pages; i++) {
        elem = document.getElementById("thumbnail" + (i + 1));
        thumbnailCanvas[i] = elem;
        thumbnailContext[i] = elem.getContext("2d");
      }



      for (var i = 0; i < 16; i++) {
        elem = document.getElementById("color_" + (i));
        elem.style.backgroundColor = colorPalette[i];
        colorElem[i] = elem;
      }

      for (var i = 0; i < pages; i++) {
        elem = document.getElementById("layerItem" + (i + 1));
        layerElem[i] = elem;

        elem = document.getElementById("layername" + (i + 1));
        layerNameElem[i] = elem;
      }


      for (var i = 0; i < pages; i++) {
        elem = document.getElementById("visibility" + (i + 1));
        elem.onclick = function (index) {
          return function () {
            toggleLayerVisible(index);
          }
        }(i);
        visibilityElem[i] = elem;
      }

      bucketElem = document.getElementById("bucket");



      visibleCanvas = document.getElementById("mainCanvas");
      visibleCanvas.addEventListener('mousedown', mouseDown, false);
      visibleCanvas.addEventListener('mouseup', mouseUp, false);
      visibleCanvas.addEventListener('mousemove', mouseMove, false);
      visibleCanvas.addEventListener('mouseout', mouseOut, false);
      visibleCanvas.addEventListener('contextmenu', canvasContextMenu, false)
      var fileUploader = document.getElementById("my_file");
      fileUploader.addEventListener('change', readFile, false);

      window.addEventListener('mouseup', mouseUp, false);

      visibleContext = visibleCanvas.getContext("2d");
      visibleContext.imageSmoothingEnabled = false;
      id = visibleContext.createImageData(1, 1); // only do this once per page
      id_d = id.data;


      createBlankDoc();

      setLayerVisible(0);
      setColor(colorIndex);

      getData();

      setVisuals(true);
      nosave = false;
      preserveUndoState(true);
    }

    function readFile(evt) {
      //Retrieve the first (and only!) File from the FileList object
      var f = evt.target.files[0];

      if (f) {
        var r = new FileReader();
        r.onload = function (e) {
          var contents = e.target.result;
          var fromToken = "<!--__EmbedBegin__-->";
          var endToken = "<!--__EmbedEnd__-->";
          var fromIndex = contents.indexOf(fromToken);
          var endIndex = contents.indexOf(endToken);
          var ss1 = contents.substr(fromIndex + fromToken.length, endIndex - fromIndex - fromToken.length);
          var ss2 = ss1.substr(ss1.indexOf("=") + 2);
          var decoded = decodeURI(ss2);
          var decoded2 = decoded.substring(0, decoded.length - 3);
          stringToState(decoded2);
          setVisuals(true);
          setLayer(canvasIndex + 1);
        }
        r.readAsText(f);
      } else {
        alert("Failed to load file");
      }
    }



    function getParameterByName(name) {
      name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
      return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }


    function strip_http(url) {
      url = url.replace(/^https?:\/\//, '');
      return url;
    }

    function getFromLocalStorage() {

      if (window.localStorage) {
        var s = localStorage.getItem("flickdeck_frames_state");
        if (s != null) {
          stringToState(s);
        }
      }
    }

    function getData() {
      var id = getParameterByName("p").replace(/[\\\/]/, "");
      if (id === null || id.length === 0) {

        getFromLocalStorage();
        return;
      }

      var githubURL = 'https://api.github.com/gists/' + id;

      var githubHTTPClient = new XMLHttpRequest();
      githubHTTPClient.open('GET', githubURL);
      githubHTTPClient.onreadystatechange = function () {
        if (githubHTTPClient.readyState != 4) {
          return;
        }
        var result = JSON.parse(githubHTTPClient.responseText);
        if (githubHTTPClient.status === 403) {
          alert(result.message);
        } else if (githubHTTPClient.status !== 200 && githubHTTPClient.status !== 201) {
          alert("HTTP Error " + githubHTTPClient.status + ' - ' + githubHTTPClient.statusText);
        }
        var result = JSON.parse(githubHTTPClient.responseText);
        var code = result["files"]["game.txt"]["content"];

        stringToState(code);
        setVisuals(true);
        setLayer(canvasIndex + 1);
      }
      githubHTTPClient.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      githubHTTPClient.send();
    }

    function drawThumbnail(n) {

      thumbCtx = thumbnailContext[n];
      thumbCtx.canvas.width = thumbwidth;
      thumbCtx.canvas.height = thumbheight;
      thumbCtx.width = thumbwidth;
      thumbCtx.height = thumbheight;

      thumbCtx.fillStyle = "#202020";
      thumbCtx.fillRect(0, 0, thumbwidth, thumbheight);

      var canvas = canvasses[n];
      var mag = width / thumbwidth;

      for (var i = 0; i < thumbwidth; i++) {
        for (var j = 0; j < thumbheight; j++) {
          var max = 0;

          outerloop:
          for (var i2 = 0; i2 < mag; i2++) {
            for (var j2 = 0; j2 < mag; j2++) {
              var sample = canvas[i * mag + i2 + width * (j * mag + j2)];
              if (sample > 0) {
                max = sample;
              }
            }
          }
          if (max > 0) {
            thumbCtx.fillStyle = colorPalette[max - 1];
            thumbCtx.fillRect(i, j, 1, 1);
          }
        }
      }

      //thumbnailCanvas[n].style.cssText = "border: 2px solid " + colorPalette[col] + ";";
      //      var dataUrl = thumbnailCanvas[n].toDataURL();
      //      "dropdownOption"[0][0].style.backgroundImage="url("+dataUrl+")";
    }

    function setVisuals(genAllThumbnails) {
      visibleContext.fillStyle = "#202020";
      visibleContext.fillRect(0, 0, zoomFactor * width, zoomFactor * height);
      for (var k = 0; k < pages; k++) {
        if (visibleCanvasses[k] === 0) {
          continue;
        }
        var canvas = canvasses[k];
        for (var i = 0; i < width; i++) {
          for (var j = 0; j < height; j++) {
            var pixelIndex = canvas[i + width * j];
            if (pixelIndex > 0) {
              visibleContext.fillStyle = colorPalette[pixelIndex - 1];
              visibleContext.fillRect(i * zoomFactor, j * zoomFactor, zoomFactor, zoomFactor);
            }
          }
        }
      }
      if (genAllThumbnails === true) {
        for (var i = 0; i < pages; i++) {
          drawThumbnail(i);
        }
      } else {
        drawThumbnail(canvasIndex);
      }
      linkInput.value = gameLink;
    }


    var drawing = 0;


    function getCoords(e) {
      var x, y;
      if (typeof e.offsetX !== "undefined") {
        x = e.offsetX;
        y = e.offsetY;
      } else {
        var target = e.target || e.srcElement;
        var rect = target.getBoundingClientRect();
        x = e.clientX - rect.left,
          y = e.clientY - rect.top;
      }
      return [x, y];
    }

    function uint8ar_copy(src) {
      var dst = new Uint8Array(width * height);
      for (var i = 0; i < src.length; i++) {
        dst[i] = src[i];
      }
      return dst;
    }

    function localStorageSave() {
      if (nosave) {
        return;
      }
      if (window.localStorage) {
        var result = stateToString();
        localStorage.setItem("flickdeck_frames_state", result);
        return result;
      }
    }

    var undoList = new Array();

    function preserveUndoState(full) {
      if (nosave) {
        return;
      }
      console.log("preserving undo state");
      var savestring = localStorageSave();
      var undoItem = new Object();
      if (full) {
        undoItem.fullstore = savestring;
      } else {
        undoItem.canvasIndex = canvasIndex;
        undoItem.script = scripts[canvasIndex];
        undoItem.canvasDat = uint8ar_copy(canvasses[canvasIndex]);
        undoItem.visibleCanvasses = visibleCanvasses.slice();
      }
      undoList.push(undoItem);
      if (undoList.length > 30) {
        undoList.shift();
      }

      if (shareLinkInner !== null) {
        shareLinkInner.style.color = "gray";
      }
    }

    function mouseDown(e) {
      e = e || window.event;
      if (e.button === 0 && !e.ctrlKey && !e.metaKey && !e.shiftKey) {
        drawing = 1;
      } else {
        drawing = -1;
      }
      var coords = getCoords(e);

      if (handMode) {
        var target = getPixelTarget(coords);
        if (target > 0) {
          interpreterActive = true;
          runScript(scripts[target - 1], target - 1)
          interpreterActive = false;
          setVisuals();
          setVisualEnabledIndicator();
          mouseMove(e);
        }
        return;
      }

      startTargetX = coords[0];
      startTargetY = coords[1];
      lastX = Math.floor(startTargetX / zoomFactor);
      lastY = Math.floor(startTargetY / zoomFactor);

      preserveUndoState();
      mouseMove(e);
      if (radius === 0) {
        drawing = 0;
      }
    }

    function mouseUp(e) {
      e = e || window.event;

      drawing = 0;
      lastX = -1;
      lastY = -1;
    }

    function mouseOut(e) {
      e = e || window.event;

      mouseMove(e);
      lastX = -1;
      lastY = -1;
    }


    function line(x1, y1, x2, y2) {
      var coordinatesArray = new Array();
      // Translate coordinates
      // Define differences and error check
      var dx = Math.abs(x2 - x1);
      var dy = Math.abs(y2 - y1);
      var sx = (x1 < x2) ? 1 : -1;
      var sy = (y1 < y2) ? 1 : -1;
      var err = dx - dy;
      // Set first coordinates
      coordinatesArray.push([x1, y1]);
      // Main loop
      while (!((x1 == x2) && (y1 == y2))) {
        var e2 = err << 1;
        if (e2 > -dy) {
          err -= dy;
          x1 += sx;
        }
        if (e2 < dx) {
          err += dx;
          y1 += sy;
        }
        // Set coordinates
        coordinatesArray.push([x1, y1]);
      }
      // Return the result
      return coordinatesArray;
    }


    function updateCursor() {
      if (handMode) {
        mainCanvas.style.cursor = "default";
      } else {
        mainCanvas.style.cursor = "crosshair";
      }
    }

    //returns -1 if nothing found, otherwise index of page whose script you could trigger
    //doesn't check for disabled/enabled
    function getPixelTarget(coords) {
      var w = visibleCanvas.width;
      var h = visibleCanvas.height;
      var wd = w / width;
      var hd = h / height;
      zoom = 1;
      if (wd < hd) {
        zoom = wd;//Math.floor(wd);
      } else {
        zoom = hd;//Math.floor(hd);
      }
      if (zoom < 1) {
        zoom = 1;
      }
      var dx = (w - width * zoom) / 2;
      var dy = (h - height * zoom) / 2;

      var x = Math.floor((coords[0] - dx) / zoom);
      var y = Math.floor((coords[1] - dy) / zoom);


      if (x >= 0 && x < width && y >= 0 && y < height) {

        for (var i = pages - 1; i >= 0; i--) {
          if (
            visibleCanvasses[i] === 1 &&
            canvasses[i][x + width * y] > 0) {
            if (scripts[i].trim() !== "" && visibleCanvasses[i] === 1 && enabled[i] === 1) {
              return i + 1;
            } else {
              return 0;
            }
          }
        }

      }
      return 0;
    }

    function mouseMove(e) {
      e = e || window.event;


      var coords = getCoords(e);

      if (handMode) {
        var target = getPixelTarget(coords);
        if (target > 0) {
          visibleCanvas.style.cursor = "pointer"
        } else {
          visibleCanvas.style.cursor = "default"
        }
        return;
      } else {
        updateCursor();
      }

      if (drawing === 0)
        return;


      var x = Math.floor(coords[0] / zoomFactor);
      var y = Math.floor(coords[1] / zoomFactor);


      var canvas = canvasses[canvasIndex];

      var points;
      if (lastX === -1) {
        points = [
          [x, y]
        ];
      } else {
        points = line(x, y, lastX, lastY);
      }

      var col = drawing > 0 ? (colorIndex + 1) : 0;

      for (var i = 0; i < points.length; i++) {
        var p = points[i];

        if (radius > 0) {
          drawCircle(canvas, p[0], p[1], radius, col);
        } else {
          floodFill(canvas, p[0], p[1], col);
        }
      }


      /*context.beginPath();
         context.arc(x, y, radius, 0, 2 * Math.PI, false);
         context.lineWidth = 0;
         context.fillStyle = 'green';
         context.fill();*/
      setVisuals();

      var coords = getCoords(e);
      lastX = Math.floor(coords[0] / zoomFactor);
      lastY = Math.floor(coords[1] / zoomFactor);


    }

    function drawCircle(canvas, x, y, radius, colorIndex) {
      radius = Math.floor(radius / 2) + 1;
      if (radius == 2) {
        var points = [
          [x, y],
          [x - 1, y],
          [x, y + 1],
          [x + 1, y],
          [x, y - 1]
        ];
        for (var i = 0; i < points.length; i++) {
          var px = points[i][0];
          var py = points[i][1];
          if (px >= 0 && px < width && py >= 0 && py < 100) {
            canvas[px + width * py] = colorIndex;
          }
        }
        return;
      } else if (radius == 3) {
        var points = [
          [x - 1, y + 2],
          [x, y + 2],
          [x + 1, y + 2],
          [x - 2, y + 1],
          [x - 1, y + 1],
          [x, y + 1],
          [x + 1, y + 1],
          [x + 2, y + 1],
          [x - 2, y],
          [x - 1, y],
          [x, y],
          [x + 1, y],
          [x + 2, y],
          [x - 2, y - 1],
          [x - 1, y - 1],
          [x, y - 1],
          [x + 1, y - 1],
          [x + 2, y - 1],
          [x - 1, y - 2],
          [x, y - 2],
          [x + 1, y - 2]
        ];
        for (var i = 0; i < points.length; i++) {
          var px = points[i][0];
          var py = points[i][1];
          if (px >= 0 && px < width && py >= 0 && py < 100) {
            canvas[px + width * py] = colorIndex;
          }
        }
        return;

      }

      for (var i = Math.max(x - radius, 0); i <= Math.min(x + radius, width - 1); i++) {
        for (var j = Math.max(y - radius, 0); j <= Math.min(y + radius, height - 1); j++) {
          var dx = i - x;
          var dy = j - y;
          if ((dx * dx + dy * dy) < radius * radius) {
            canvas[i + width * j] = colorIndex;
          }
        }
      }
    }

    function floodFill(canvas, x, y, colorIndex) {
      var points = [
        [x, y]
      ];
      originColor = canvas[x + width * y];
      if (originColor === colorIndex) {
        return;
      }

      for (var i = 0; i < points.length; i++) {
        var p = points[i];
        var pIndex = p[0] + width * p[1];
        if (canvas[pIndex] === colorIndex) {
          continue;
        } else {
          canvas[pIndex] = colorIndex;
          borderPoints = [
            [p[0] + 1, p[1]],
            [p[0] - 1, p[1]],
            [p[0], p[1] + 1],
            [p[0], p[1] - 1]
          ];
          for (var j = 0; j < borderPoints.length; j++) {
            var borderPoint = borderPoints[j];
            var bpx = borderPoint[0];
            var bpy = borderPoint[1];
            var bpi = bpx + width * bpy;
            if (
              bpx >= 0 &&
              bpx < width &&
              bpy >= 0 &&
              bpy < height &&
              canvas[bpi] === originColor) {
              points.push([bpx, bpy]);
            }
          }
        }
      }
    }
  </script>

  <style type="text/css">
    /*<![CDATA[*/

    canvas {
      image-rendering: optimizeSpeed;
      image-rendering: -moz-crisp-edges;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: -o-crisp-edges;
      image-rendering: pixelated;
      -ms-interpolation-mode: nearest-neighbor;
    }

    #maincanvas {
      cursor: crosshair;
      margin: 0;
      padding: 0;
    }

    #undertable {
      margin: 0;
      padding: 5px;
      /*border:2px solid gray; */
      border-top: none;
      width: 820px;
      display: inline-block;
    }

    #undertable td {
      width: 20px;
    }

    body {
      -webkit-user-select: none;
      /* webkit (safari, chrome) browsers */
      -moz-user-select: none;
      /* mozilla browsers */
      -khtml-user-select: none;
      /* webkit (konqueror) browsers */
      -ms-user-select: none;
      /* IE10+ */
    }

    select {
      background-color: black;
      color: white;
      text-indent: 5px;
    }

    canvas {
      position: relative;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: #323232;
      color: gray;
      margin-top: 0;
      padding-top: 0;
      border-top: 0;
    }

    input {
      background-color: gray;
      color: white;
      font-size: 100%;
      text-align: left;
      margin-bottom: 0px;
    }

    textarea {
      font-family: Consolas, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace;

      background-color: black;
      color: white;
      font-size: 60%;
      text-align: left;
      margin-bottom: 0px;
      width: 150px;
      border-top: 0;
      resize: none;
      height: 60px;
      overflow: none;
      border: 1px solid gray;
    }

    input#titleinput {
      background-color: black;
      color: white;
      font-size: 200%;
      text-align: center;
      margin-bottom: 5px;
    }

    input#linkInput {
      background-color: black;
      color: white;
      font-size: 150%;
      text-align: center;
      margin-bottom: 5px;
      padding-bottom: 3px;
    }

    li {
      font-size: 150%;
      text-align: left;
      width: 100px;
    }

    a {
      color: white;
    }

    .layerThumbnail {
      margin-left: 5px;
      border: 2px solid gray;
      background-color: black;
      width: 30;
      height: 15;
    }

    ul {
      list-style-type: none;
      overflow: hidden;
      overflow-y: none;
      padding: 0;
      margin: 0;
      margin-right: 5px;
      margin-left: 5px;
    }

    a.layerItem {
      color: white;
      background-color: none;
      text-decoration: none;
      width: 80px;
      /*display:block;*/
    }

    a.layerItem.selectedItem {
      color: black;
      background-color: white;
    }

    img.selected {
      border: 2px solid red;
    }

    li.selected {
      cursor: auto;
      color: white;
    }

    a {
      white-space: nowrap;
    }

    div.selected {
      height: 25px;
      width: 40px;
      border: 2px solid red;
    }

    div.unselected {
      height: 27px;
      width: 42px;
      border: 1px solid black;
    }

    img.radius {
      border: 1px solid black;
    }

    img.selected {
      border: 1px solid red;
    }

    select {
      width: 100%;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    select::-ms-expand {
      display: none;
    }

    canvas#dropdownthumb {
      border: 2px solid gray;
      background-color: black;
    }

    .eyeButton {
      display: inline-block;
      width: 20px;
      height: 20px;
    }

    /*]]>*/
  </style>
  <title>
    FLICKSCRIPT
  </title>
</head>

<body onload="init();" ondragstart="return false;" ondrop="return false;">
  <center>
    <table cellpadding="0">
      <tr>
        <td>
          <ul>
            <li>
              <img id="visibility1" class="eyeButton" src="eye2.png"> <a class="layerItem selectedItem" id="layerItem1"
                href="#" onclick="setLayer(1);return false;">
                <canvas id="thumbnail1" class="layerThumbnail"></canvas>
                <span id="layername1" class="enabledlayer">1</span></a>
            </li>
            <li>
              <img id="visibility2" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem2" href="#"
                onclick="setLayer(2);return false;">
                <canvas id="thumbnail2" class="layerThumbnail"></canvas>
                <span id="layername2" class="enabledlayer">2</span></a>
            </li>
            <li>
              <img id="visibility3" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem3" href="#"
                onclick="setLayer(3);return false;">
                <canvas id="thumbnail3" class="layerThumbnail"></canvas>
                <span id="layername3" class="enabledlayer">3</span></a>
            </li>
            <li>
              <img id="visibility4" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem4" href="#"
                onclick="setLayer(4);return false;">
                <canvas id="thumbnail4" class="layerThumbnail"></canvas>
                <span id="layername4" class="enabledlayer">4</span></a>
            </li>
            <li>
              <img id="visibility5" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem5" href="#"
                onclick="setLayer(5);return false;">
                <canvas id="thumbnail5" class="layerThumbnail"></canvas>
                <span id="layername5" class="enabledlayer">5</span></a>
            </li>
            <li>
              <img id="visibility6" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem6" href="#"
                onclick="setLayer(6);return false;">
                <canvas id="thumbnail6" class="layerThumbnail"></canvas>
                <span id="layername6" class="enabledlayer">6</span></a>
            </li>
            <li>
              <img id="visibility7" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem7" href="#"
                onclick="setLayer(7);return false;">
                <canvas id="thumbnail7" class="layerThumbnail"></canvas>
                <span id="layername7" class="enabledlayer">7</span></a>
            </li>
            <li>
              <img id="visibility8" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem8" href="#"
                onclick="setLayer(8);return false;">
                <canvas id="thumbnail8" class="layerThumbnail"></canvas>
                <span id="layername8" class="enabledlayer">8</span></a>
            </li>
            <li>
              <img id="visibility9" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem9" href="#"
                onclick="setLayer(9);return false;">
                <canvas id="thumbnail9" class="layerThumbnail"></canvas>
                <span id="layername9" class="enabledlayer">9</span></a>
            </li>
            <li>
              <img id="visibility10" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem10" href="#"
                onclick="setLayer(10);return false;">
                <canvas id="thumbnail10" class="layerThumbnail"></canvas>
                <span id="layername10" class="enabledlayer">10</span></a>
            </li>
            <li>
              <img id="visibility11" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem11" href="#"
                onclick="setLayer(11);return false;">
                <canvas id="thumbnail11" class="layerThumbnail"></canvas>
                <span id="layername11" class="enabledlayer">11</span></a>
            </li>
            <li>
              <img id="visibility12" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem12" href="#"
                onclick="setLayer(12);return false;">
                <canvas id="thumbnail12" class="layerThumbnail"></canvas>
                <span id="layername12" class="enabledlayer">12</span></a>
            </li>
            <li>
              <img id="visibility13" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem13" href="#"
                onclick="setLayer(13);return false;">
                <canvas id="thumbnail13" class="layerThumbnail"></canvas>
                <span id="layername13" class="enabledlayer">13</span></a>
            </li>
            <li>
              <img id="visibility14" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem14" href="#"
                onclick="setLayer(14);return false;">
                <canvas id="thumbnail14" class="layerThumbnail"></canvas>
                <span id="layername14" class="enabledlayer">14</span></a>
            </li>
            <li>
              <img id="visibility15" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem15" href="#"
                onclick="setLayer(15);return false;">
                <canvas id="thumbnail15" class="layerThumbnail"></canvas>
                <span id="layername15" class="enabledlayer">15</span></a>
            </li>
            <li>
              <img id="visibility16" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem16" href="#"
                onclick="setLayer(16);return false;">
                <canvas id="thumbnail16" class="layerThumbnail"></canvas>
                <span id="layername16" class="enabledlayer">16</span></a>
            </li>
            <li>
              <img id="visibility17" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem17" href="#"
                onclick="setLayer(17);return false;">
                <canvas id="thumbnail17" class="layerThumbnail"></canvas>
                <span id="layername17" class="enabledlayer">17</span></a>
            </li>
            <li>
              <img id="visibility18" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem18" href="#"
                onclick="setLayer(18);return false;">
                <canvas id="thumbnail18" class="layerThumbnail"></canvas>
                <span id="layername18" class="enabledlayer">18</span></a>
            </li>
            <li>
              <img id="visibility19" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem19" href="#"
                onclick="setLayer(19);return false;">
                <canvas id="thumbnail19" class="layerThumbnail"></canvas>
                <span id="layername19" class="enabledlayer">19</span></a>
            </li>

            <li>
              <img id="visibility20" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem20" href="#"
                onclick="setLayer(20);return false;">
                <canvas id="thumbnail20" class="layerThumbnail"></canvas>
                <span id="layername20" class="enabledlayer">20</span></a>
            </li>


            <li>
              <img id="visibility21" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem21" href="#"
                onclick="setLayer(21);return false;">
                <canvas id="thumbnail21" class="layerThumbnail"></canvas>
                <span id="layername21" class="enabledlayer">21</span></a>
            </li>


            <li>
              <img id="visibility22" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem22" href="#"
                onclick="setLayer(22);return false;">
                <canvas id="thumbnail22" class="layerThumbnail"></canvas>
                <span id="layername22" class="enabledlayer">22</span></a>
            </li>


            <li>
              <img id="visibility23" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem23" href="#"
                onclick="setLayer(23);return false;">
                <canvas id="thumbnail23" class="layerThumbnail"></canvas>
                <span id="layername23" class="enabledlayer">23</span></a>
            </li>


            <li>
              <img id="visibility24" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem24" href="#"
                onclick="setLayer(24);return false;">
                <canvas id="thumbnail24" class="layerThumbnail"></canvas>
                <span id="layername24" class="enabledlayer">24</span></a>
            </li>


            <li>
              <img id="visibility25" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem25" href="#"
                onclick="setLayer(25);return false;">
                <canvas id="thumbnail25" class="layerThumbnail"></canvas>
                <span id="layername25" class="enabledlayer">25</span></a>
            </li>

          </ul>
        </td>
        <td>
          <ul>

            <li>
              <img id="visibility26" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem26" href="#"
                onclick="setLayer(26);return false;">
                <canvas id="thumbnail26" class="layerThumbnail"></canvas>
                <span id="layername26" class="enabledlayer">26</span></a>
            </li>
            <li>
              <img id="visibility27" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem27" href="#"
                onclick="setLayer(27);return false;">
                <canvas id="thumbnail27" class="layerThumbnail"></canvas>
                <span id="layername27" class="enabledlayer">27</span></a>
            </li>
            <li>
              <img id="visibility28" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem28" href="#"
                onclick="setLayer(28);return false;">
                <canvas id="thumbnail28" class="layerThumbnail"></canvas>
                <span id="layername28" class="enabledlayer">28</span></a>
            </li>
            <li>
              <img id="visibility29" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem29" href="#"
                onclick="setLayer(29);return false;">
                <canvas id="thumbnail29" class="layerThumbnail"></canvas>
                <span id="layername29" class="enabledlayer">29</span></a>
            </li>
            <li>
              <img id="visibility30" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem30" href="#"
                onclick="setLayer(30);return false;">
                <canvas id="thumbnail30" class="layerThumbnail"></canvas>
                <span id="layername30" class="enabledlayer">30</span></a>
            </li>
            <li>
              <img id="visibility31" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem31" href="#"
                onclick="setLayer(31);return false;">
                <canvas id="thumbnail31" class="layerThumbnail"></canvas>
                <span id="layername31" class="enabledlayer">31</span></a>
            </li>
            <li>
              <img id="visibility32" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem32" href="#"
                onclick="setLayer(32);return false;">
                <canvas id="thumbnail32" class="layerThumbnail"></canvas>
                <span id="layername32" class="enabledlayer">32</span></a>
            </li>
            <li>
              <img id="visibility33" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem33" href="#"
                onclick="setLayer(33);return false;">
                <canvas id="thumbnail33" class="layerThumbnail"></canvas>
                <span id="layername33" class="enabledlayer">33</span></a>
            </li>
            <li>
              <img id="visibility34" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem34" href="#"
                onclick="setLayer(34);return false;">
                <canvas id="thumbnail34" class="layerThumbnail"></canvas>
                <span id="layername34" class="enabledlayer">34</span></a>
            </li>
            <li>
              <img id="visibility35" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem35" href="#"
                onclick="setLayer(35);return false;">
                <canvas id="thumbnail35" class="layerThumbnail"></canvas>
                <span id="layername35" class="enabledlayer">35</span></a>
            </li>
            <li>
              <img id="visibility36" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem36" href="#"
                onclick="setLayer(36);return false;">
                <canvas id="thumbnail36" class="layerThumbnail"></canvas>
                <span id="layername36" class="enabledlayer">36</span></a>
            </li>
            <li>
              <img id="visibility37" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem37" href="#"
                onclick="setLayer(37);return false;">
                <canvas id="thumbnail37" class="layerThumbnail"></canvas>
                <span id="layername37" class="enabledlayer">37</span></a>
            </li>
            <li>
              <img id="visibility38" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem38" href="#"
                onclick="setLayer(38);return false;">
                <canvas id="thumbnail38" class="layerThumbnail"></canvas>
                <span id="layername38" class="enabledlayer">38</span></a>
            </li>
            <li>
              <img id="visibility39" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem39" href="#"
                onclick="setLayer(39);return false;">
                <canvas id="thumbnail39" class="layerThumbnail"></canvas>
                <span id="layername39" class="enabledlayer">39</span></a>
            </li>

            <li>
              <img id="visibility40" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem40" href="#"
                onclick="setLayer(40);return false;">
                <canvas id="thumbnail40" class="layerThumbnail"></canvas>
                <span id="layername40" class="enabledlayer">40</span></a>
            </li>

            <li>
              <img id="visibility41" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem41" href="#"
                onclick="setLayer(41);return false;">
                <canvas id="thumbnail41" class="layerThumbnail"></canvas>
                <span id="layername41" class="enabledlayer">41</span></a>
            </li>
            <li>
              <img id="visibility42" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem42" href="#"
                onclick="setLayer(42);return false;">
                <canvas id="thumbnail42" class="layerThumbnail"></canvas>
                <span id="layername42" class="enabledlayer">42</span></a>
            </li>
            <li>
              <img id="visibility43" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem43" href="#"
                onclick="setLayer(43);return false;">
                <canvas id="thumbnail43" class="layerThumbnail"></canvas>
                <span id="layername43" class="enabledlayer">43</span></a>
            </li>
            <li>
              <img id="visibility44" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem44" href="#"
                onclick="setLayer(44);return false;">
                <canvas id="thumbnail44" class="layerThumbnail"></canvas>
                <span id="layername44" class="enabledlayer">44</span></a>
            </li>
            <li>
              <img id="visibility45" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem45" href="#"
                onclick="setLayer(45);return false;">
                <canvas id="thumbnail45" class="layerThumbnail"></canvas>
                <span id="layername45" class="enabledlayer">45</span></a>
            </li>


            <li>
              <img id="visibility46" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem46" href="#"
                onclick="setLayer(46);return false;">
                <canvas id="thumbnail46" class="layerThumbnail"></canvas>
                <span id="layername46" class="enabledlayer">46</span></a>
            </li>
            <li>
              <img id="visibility47" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem47" href="#"
                onclick="setLayer(47);return false;">
                <canvas id="thumbnail47" class="layerThumbnail"></canvas>
                <span id="layername47" class="enabledlayer">47</span></a>
            </li>
            <li>
              <img id="visibility48" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem48" href="#"
                onclick="setLayer(48);return false;">
                <canvas id="thumbnail48" class="layerThumbnail"></canvas>
                <span id="layername48" class="enabledlayer">48</span></a>
            </li>
            <li>
              <img id="visibility49" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem49" href="#"
                onclick="setLayer(49);return false;">
                <canvas id="thumbnail49" class="layerThumbnail"></canvas>
                <span id="layername49" class="enabledlayer">49</span></a>
            </li>

            <li>
              <img id="visibility50" class="eyeButton" src="eye2.png"> <a class="layerItem" id="layerItem50" href="#"
                onclick="setLayer(50);return false;">
                <canvas id="thumbnail50" class="layerThumbnail"></canvas>
                <span id="layername50" class="enabledlayer">50</span></a>
            </li>

          </ul>
        </td>



        <td valign="top">
          <table>
            <tr>
              <td>
                <table>
                  <tr>
                    <td>
                      <center>
                        <input width="800" style="border:2px solid gray;" onkeydown="event.stopPropagation();"
                          value="www.flickgame.org/flickscript.html" id="linkInput" oninput="linkChange(this.value)" />
                        <br />
                        <canvas id="mainCanvas" width="800" height="400"
                          style="border:2px solid gray; background-color:black;"></canvas>
                        <br />
                        <table id="underTable" margin="0">


                          <tr height="16">
                            <td>
                              <a href="#" onclick="setColor(0);return false;">
                                <div class="unselected" id="color_0"></div>
                              </a>
                            </td>


                            <td>
                              <a href="#" onclick="setColor(1);return false;">
                                <div class="unselected" id="color_1"></div>
                              </a>
                            </td>

                            <td rowspan="9">


                              <textarea id="code" name="code"
                                style="margin:10px;width:640px;height:250px;margin:0;padding:0;margin-left: 10px;"></textarea>
                            </td>

                          </tr>

                          <tr height="16">
                            <td>
                              <a href="#" onclick="setColor(2);return false;">
                                <div class="selected" id="color_2"></div>
                              </a>
                            </td>

                            <td>
                              <a href="#" onclick="setColor(3);return false;">
                                <div class="unselected" id="color_3"></div>
                              </a>
                            </td>
                          </tr>
                          <tr height="16">
                            <td>
                              <a href="#" onclick="setColor(4);return false;">
                                <div class="unselected" id="color_4"></div>
                              </a>
                            </td>


                            <td>
                              <a href="#" onclick="setColor(5);return false;">
                                <div class="unselected" id="color_5"></div>
                              </a>
                            </td>

                          </tr>
                          <tr height="16">
                            <td>
                              <a href="#" onclick="setColor(6);return false;">
                                <div class="unselected" id="color_6"></div>
                              </a>
                            </td>
                            <td>
                              <a href="#" onclick="setColor(7);return false;">
                                <div class="unselected" id="color_7"></div>
                              </a>
                            </td>

                          </tr>



                          <tr height="16">
                            <td>
                              <a href="#" onclick="setColor(8);return false;">
                                <div class="unselected" id="color_8"></div>
                              </a>
                            </td>


                            <td>
                              <a href="#" onclick="setColor(9);return false;">
                                <div class="unselected" id="color_9"></div>
                              </a>
                            </td>


                          </tr>
                          <tr height="16">
                            <td>
                              <a href="#" onclick="setColor(10);return false;">
                                <div class="unselected" id="color_10"></div>
                              </a>
                            </td>

                            <td>
                              <a href="#" onclick="setColor(11);return false;">
                                <div class="unselected" id="color_11"></div>
                              </a>
                            </td>
                          </tr>



                          <tr height="16">
                            <td>
                              <a href="#" onclick="setColor(12);return false;">
                                <div class="unselected" id="color_12"></div>
                              </a>
                            </td>

                            <td>
                              <a href="#" onclick="setColor(13);return false;">
                                <div class="unselected" id="color_13"></div>
                              </a>
                            </td>
                          </tr>
                          <tr height="16">
                            <td>
                              <a href="#" onclick="setColor(14);return false;">
                                <div class="unselected" id="color_14"></div>
                              </a>
                            </td>

                            <td>
                              <a href="#" onclick="setColor(15);return false;">
                                <div class="unselected" id="color_15"></div>
                              </a>
                            </td>

                          </tr>

                          <tr>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                          </tr>
                        </table>
                      </center>
                    </td>
                    <td valign="top">
                      <a href="#" onclick="shareClick();return false;">&ocir; share</a><br />
                      <div id="shareLink"></div>
                      <a href="#" onclick="exportClick();return false;">&sdotb; export</a><br />
                      <a href="#" onclick="document.getElementById('my_file').click();return false;">&sdotb;
                        import</a><br />
                      <input type="file" accept=".html" id="my_file" style="display: none;" />
                      <a href="flickscript_help.html" target="_blank" title="blah">? help</a>
                      <br />
                      <br />
                      <a href="#" onclick="rewind();return false;"><img src="rewind.png" class="radius"
                          id="rewind" /></a>
                      <br />
                      <br />
                      <a href="#" onclick="setHand();return false;"><img src="hand.png" class="radius"
                          id="sethand" /></a>
                      <br />
                      <br />
                      <a href="#" onclick="setRadius(16);return false;"><img src="16.png" class="radius"
                          id="radius_16" /></a>
                      <br />
                      <a href="#" onclick="setRadius(13);return false;"><img src="13.png" class="radius"
                          id="radius_13" /></a>
                      <br />
                      <a href="#" onclick="setRadius(11);return false;"><img src="11.png" class="radius"
                          id="radius_11" /></a>
                      <br />
                      <a href="#" onclick="setRadius(9);return false;"><img src="9.png" class="radius"
                          id="radius_9" /></a>
                      <br />
                      <a href="#" onclick="setRadius(7);return false;"><img src="7.png" class="radius"
                          id="radius_7" /></a>
                      <br />
                      <a href="#" onclick="setRadius(5);return false;"><img src="5.png" class="radius selected"
                          id="radius_5" /></a>
                      <br />
                      <a href="#" onclick="setRadius(3);return false;"><img src="3.png" class="radius"
                          id="radius_3" /></a>
                      <br />
                      <a href="#" onclick="setRadius(1);return false;"><img src="1.png" class="radius"
                          id="radius_1" /></a>
                      <br />
                      <a href="#" onclick="setRadius(0);return false;"><img src="bucket.png" class="radius"
                          id="bucket" /></a>
                      <br />
                      <a href="#" onclick="clearPalette();return false;"><img src="clear.png" class="radius"
                          id="bucket" /></a>
                      <br /><br>
                      <a href="#" onclick="newDoc();return false;"><img src="newdoc.png" class="radius"
                          id="bucket" /></a>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
  </center>


</body>

</html>