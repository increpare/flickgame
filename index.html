<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  
  <meta name="Description" CONTENT="Draw and share simple games with your mouse or fingers!">

  <link rel="icon" type="image/png" href="favicon.png">
  <script src="FileSaver.js"></script>
  <script type="text/javascript">
    var contexts = new Array();
    var version = "0.1";
    var gameLink = "www.flickgame.org"
    var canvasIndex = 0;
    var palette_name = "dawnbringer-16";
    var background_color = "#000000";
    var foreground_color = "#ffffff";
    var canvasses = new Array();
      var hyperlinks = new Array();
      //16 arrays of 16 elements, filled with 0s
      for (var i = 0; i < 16; i++){
        hyperlinks[i] = new Array(16).fill(0);
    }

    var shareLinkInner = null;

    var palettes = {
  antiquity16: [
    '#202020', '#2d211e',
    '#452923', '#6d3d29',
    '#b16b4a', '#e89f6e',
    '#e8be82', '#5d7557',
    '#8e9257', '#707b88',
    '#8aa7ac', '#e55d4d',
    '#f1866c', '#d26730',
    '#de9a28', '#e8d8a5'
  ],
  arq16: [
    '#ffffff', '#ffd19d',
    '#aeb5bd', '#4d80c9',
    '#e93841', '#100820',
    '#511e43', '#054494',
    '#f1892d', '#823e2c',
    '#ffa9a9', '#5ae150',
    '#ffe947', '#7d3ebf',
    '#eb6c82', '#1e8a4c'
  ],
  'bubblegum-16': [
    '#16171a', '#7f0622',
    '#d62411', '#ff8426',
    '#ffd100', '#fafdff',
    '#ff80a4', '#ff2674',
    '#94216a', '#430067',
    '#234975', '#68aed4',
    '#bfff3c', '#10d275',
    '#007899', '#002859'
  ],
  colodore: [
    '#000000', '#4a4a4a',
    '#7b7b7b', '#b2b2b2',
    '#ffffff', '#813338',
    '#c46c71', '#553800',
    '#8e5029', '#edf171',
    '#a9ff9f', '#56ac4d',
    '#75cec8', '#706deb',
    '#2e2c9b', '#8e3c97'
  ],
  'color-graphics-adapter': [
    '#000000', '#555555',
    '#aaaaaa', '#ffffff',
    '#0000aa', '#5555ff',
    '#00aa00', '#55ff55',
    '#00aaaa', '#55ffff',
    '#aa0000', '#ff5555',
    '#aa00aa', '#ff55ff',
    '#aa5500', '#ffff55'
  ],
  commodore64: [
    '#000000', '#626262',
    '#898989', '#adadad',
    '#ffffff', '#9f4e44',
    '#cb7e75', '#6d5412',
    '#a1683c', '#c9d487',
    '#9ae29b', '#5cab5e',
    '#6abfc6', '#887ecb',
    '#50459b', '#a057a3'
  ],
  'cretaceous-16': [
    '#313432', '#323e42',
    '#454b4b', '#3a5f3b',
    '#7c4545', '#675239',
    '#625055', '#516b43',
    '#796c64', '#718245',
    '#9e805c', '#998579',
    '#ac9086', '#a6a296',
    '#b4ab8f', '#bcb7a5'
  ],
  'darkseed-16': [
    '#000000', '#001418',
    '#002024', '#002c38',
    '#143444', '#443444',
    '#583c48', '#6c4c44',
    '#806058', '#6c706c',
    '#888078', '#a49484',
    '#c4ac9c', '#d8b0a8',
    '#ecd4d0', '#fcfcfc'
  ],
  'dawnbringer-16': [
    '#140c1c', '#442434',
    '#30346d', '#4e4a4e',
    '#854c30', '#346524',
    '#d04648', '#757161',
    '#597dce', '#d27d2c',
    '#8595a1', '#6daa2c',
    '#d2aa99', '#6dc2ca',
    '#dad45e', '#deeed6'
  ],
  'daylight-16': [
    '#f2d3ac', '#e7a76c',
    '#c28462', '#905b54',
    '#513a3d', '#7a6977',
    '#878c87', '#b5c69a',
    '#272223', '#606b31',
    '#b19e3f', '#f8c65c',
    '#d58b39', '#996336',
    '#6a422c', '#b55b39'
  ],
  'endesga-16': [
    '#e4a672', '#b86f50',
    '#743f39', '#3f2832',
    '#9e2835', '#e53b44',
    '#fb922b', '#ffe762',
    '#63c64d', '#327345',
    '#193d3f', '#4f6781',
    '#afbfd2', '#ffffff',
    '#2ce8f4', '#0484d1'
  ],
  'eroge-copper': [
    '#0d080d', '#4f2b24',
    '#825b31', '#c59154',
    '#f0bd77', '#fbdf9b',
    '#fff9e4', '#bebbb2',
    '#7bb24e', '#74adbb',
    '#4180a0', '#32535f',
    '#2a2349', '#7d3840',
    '#c16c5b', '#e89973'
  ],
  'fading-16': [
    '#ddcf99', '#cca87b',
    '#b97a60', '#9c524e',
    '#774251', '#4b3d44',
    '#4e5463', '#5b7d73',
    '#8e9f7d', '#645355',
    '#8c7c79', '#a99c8d',
    '#7d7b62', '#aaa25d',
    '#846d59', '#a88a5e'
  ],
  'galaxy-flame': [
    '#699fad', '#3a708e',
    '#2b454f', '#111215',
    '#151d1a', '#1d3230',
    '#314e3f', '#4f5d42',
    '#9a9f87', '#ede6cb',
    '#f5d893', '#e8b26f',
    '#b6834c', '#704d2b',
    '#40231e', '#151015'
  ],
  'go-line': [
    '#430067', '#94216a',
    '#ff004d', '#ff8426',
    '#ffdd34', '#50e112',
    '#3fa66f', '#365987',
    '#000000', '#0033ff',
    '#29adff', '#00ffcc',
    '#fff1e8', '#c2c3c7',
    '#ab5236', '#5f574f'
  ],
  'grayscale-16': [
    '#000000', '#181818',
    '#282828', '#383838',
    '#474747', '#565656',
    '#646464', '#717171',
    '#7e7e7e', '#8c8c8c',
    '#9b9b9b', '#ababab',
    '#bdbdbd', '#d1d1d1',
    '#e7e7e7', '#ffffff'
  ],
  'island-joy-16': [
    '#ffffff', '#6df7c1',
    '#11adc1', '#606c81',
    '#393457', '#1e8875',
    '#5bb361', '#a1e55a',
    '#f7e476', '#f99252',
    '#cb4d68', '#6a3771',
    '#c92464', '#f48cb6',
    '#f7b69e', '#9b9c82'
  ],
  'lost-century': [
    '#d1b187', '#c77b58',
    '#ae5d40', '#79444a',
    '#4b3d44', '#ba9158',
    '#927441', '#4d4539',
    '#77743b', '#b3a555',
    '#d2c9a5', '#8caba1',
    '#4b726e', '#574852',
    '#847875', '#ab9b8e'
  ],
  'microsoft-windows': [
    '#000000', '#7e7e7e',
    '#bebebe', '#ffffff',
    '#7e0000', '#fe0000',
    '#047e00', '#06ff04',
    '#7e7e00', '#ffff04',
    '#00007e', '#0000ff',
    '#7e007e', '#fe00ff',
    '#047e7e', '#06ffff'
  ],
  'miyazaki-16': [
    '#232228', '#284261',
    '#5f5854', '#878573',
    '#b8b095', '#c3d5c7',
    '#ebecdc', '#2485a6',
    '#54bad2', '#754d45',
    '#c65046', '#e6928a',
    '#1e7453', '#55a058',
    '#a1bf41', '#e3c054'
  ],
  na16: [
    '#8c8fae', '#584563',
    '#3e2137', '#9a6348',
    '#d79b7d', '#f5edba',
    '#c0c741', '#647d34',
    '#e4943a', '#9d303b',
    '#d26471', '#70377f',
    '#7ec4c1', '#34859d',
    '#17434b', '#1f0e1c'
  ],
  'nanner-jam': [
    '#352b40', '#653d48',
    '#933f45', '#b25e46',
    '#cc925e', '#dacb80',
    '#f0e9c9', '#76c379',
    '#508d76', '#535c89',
    '#7b99c8', '#99d4e6',
    '#be7979', '#d8b1a1',
    '#7d6e6e', '#c2b5a9'
  ],
  'pico-8': [
    '#000000', '#1D2B53',
    '#7E2553', '#008751',
    '#AB5236', '#5F574F',
    '#C2C3C7', '#FFF1E8',
    '#FF004D', '#FFA300',
    '#FFEC27', '#00E436',
    '#29ADFF', '#83769C',
    '#FF77A8', '#FFCCAA'
  ],
  'r-place': [
    '#FFFFFF', '#E4E4E4',
    '#888888', '#222222',
    '#FFA7D1', '#E50000',
    '#E59500', '#A06A42',
    '#E5D900', '#94E044',
    '#02BE01', '#00D3DD',
    '#0083C7', '#0000EA',
    '#CF6EE4', '#820080'
  ],
  'shido-cyberneon': [
    '#00033c', '#005260',
    '#009d4a', '#0aff52',
    '#003884', '#008ac5',
    '#00f7ff', '#ff5cff',
    '#ac29ce', '#600088',
    '#b10585', '#ff004e',
    '#2a2e79', '#4e6ea8',
    '#add4fa', '#ffffff'
  ],
  'steam-lords': [
    '#213b25', '#3a604a',
    '#4f7754', '#a19f7c',
    '#77744f', '#775c4f',
    '#603b3a', '#3b2137',
    '#170e19', '#2f213b',
    '#433a60', '#4f5277',
    '#65738c', '#7c94a1',
    '#a0b9ba', '#c0d1cc'
  ],
  'summers-past-16': [
    '#320011', '#5f3a60',
    '#876672', '#b7a39d',
    '#ece8c2', '#6db7c3',
    '#5e80b2', '#627057',
    '#8da24e', '#d2cb3e',
    '#f7d554', '#e8bf92',
    '#e78c5b', '#c66f5e',
    '#c33846', '#933942'
  ],
  'sweetie-16': [
    '#1a1c2c', '#5d275d',
    '#b13e53', '#ef7d57',
    '#ffcd75', '#a7f070',
    '#38b764', '#257179',
    '#29366f', '#3b5dc9',
    '#41a6f6', '#73eff7',
    '#f4f4f4', '#94b0c2',
    '#566c86', '#333c57'
  ],
  'taffy-16': [
    '#222533', '#6275ba',
    '#a3c0e6', '#fafffc',
    '#ffab7b', '#ff6c7a',
    '#dc435b', '#3f48c2',
    '#448de7', '#2bdb72',
    '#a7f547', '#ffeb33',
    '#f58931', '#db4b3d',
    '#a63d57', '#36354d'
  ],
  'urbex-16': [
    '#cbd1be', '#8f9389',
    '#52534c', '#26201d',
    '#e0a46e', '#91a47a',
    '#5d7643', '#4d533a',
    '#a93130', '#7a1338',
    '#834664', '#917692',
    '#160712', '#593084',
    '#3870be', '#579fb4'
  ],
  'vanilla-milkshake': [
    '#28282e', '#6c5671',
    '#d9c8bf', '#f98284',
    '#b0a9e4', '#accce4',
    '#b3e3da', '#feaae4',
    '#87a889', '#b0eb93',
    '#e9f59d', '#ffe6c6',
    '#dea38b', '#ffc384',
    '#fff7a0', '#fff7e4'
  ],
  woodspark: [
    '#f5eeb0', '#fabf61',
    '#e08d51', '#8a5865',
    '#452b3f', '#2c5e3b',
    '#609c4f', '#c6cc54',
    '#78c2d6', '#5479b0',
    '#56546e', '#839fa6',
    '#e0d3c8', '#f05b5b',
    '#8f325f', '#eb6c98'
  ]
};


function rgbToLab(r,g,b) {
  r /= 255;
  g /= 255;
  b /= 255;
  r = (r > 0.04045) ? (((r + 0.055) / 1.055) ** 2.4) : r / 12.92;
  g = (g > 0.04045) ? (((g + 0.055) / 1.055) ** 2.4) : g / 12.92;
  b = (b > 0.04045) ? (((b + 0.055) / 1.055) ** 2.4) : b / 12.92;
  var x = (r * 0.4124 + g * 0.3576 + b * 0.1805) / 0.95047;
  var y = (r * 0.2126 + g * 0.7152 + b * 0.0722) / 1.00000;
  var z = (r * 0.0193 + g * 0.1192 + b * 0.9505) / 1.08883;
  x = (x > 0.008856) ? (x ** (1 / 3)) : (7.787 * x) + 16 / 116;
  y = (y > 0.008856) ? (y ** (1 / 3)) : (7.787 * y) + 16 / 116;
  z = (z > 0.008856) ? (z ** (1 / 3)) : (7.787 * z) + 16 / 116;
  return {
    L: (116 * y) - 16,
    a: 500 * (x - y),
    b: 200 * (y - z),
  };
}

  function color_distance(color1, color2) {
    // Convert hex colors to RGB
    const r1 = parseInt(color1.slice(1,3), 16);
    const g1 = parseInt(color1.slice(3,5), 16);
    const b1 = parseInt(color1.slice(5,7), 16);
    
    const r2 = parseInt(color2.slice(1,3), 16);
    const g2 = parseInt(color2.slice(3,5), 16);
    const b2 = parseInt(color2.slice(5,7), 16);
    
    // Convert to LAB
    const lab1 = rgbToLab(r1, g1, b1);
    const lab2 = rgbToLab(r2, g2, b2);
    
    // Calculate Delta E using the CIE76 formula
    const deltaL = lab1.L - lab2.L;
    const deltaA = lab1.a - lab2.a;
    const deltaB = lab1.b - lab2.b;
    
    return Math.sqrt(deltaL * deltaL + deltaA * deltaA + deltaB * deltaB);
  }



    function nearest_color_in_palette(palette,target_color){
      var nearest_color = palette[0];
      var nearest_distance = color_distance(target_color, palette[0]);
      for (var i = 1; i < palette.length; i++){
        var distance = color_distance(target_color, palette[i]);
        if (distance < nearest_distance){
          nearest_distance = distance;
          nearest_color = palette[i];
        }
      }
      return nearest_color;
    }

    function furthest_color_in_palette(palette,target_color){
      var furthest_color = palette[0];
      var furthest_distance = color_distance(target_color, palette[0]);
      for (var i = 1; i < palette.length; i++){
        var distance = color_distance(target_color, palette[i]);
        if (distance > furthest_distance){
          furthest_distance = distance;
          furthest_color = palette[i];
        }
      }
      return furthest_color;
    }
          
    function find_palette_transformation(palettea,paletteb){
      //finds what colours in the second palette correspond most closely to those in the first palette - has to be a 1-1 mapping.
      var mapping = {};
      
      var colors_to_allocate = palettea.concat([]);
      var colors_to_target = paletteb.concat([]);
      while (colors_to_allocate.length > 0){
       //from all the pairs of colors colors_to_allocate,paletteb, find the pair with the least distance.
       var best_distance = Infinity;
       var best_pair = null;
       for (var i = 0; i < colors_to_allocate.length; i++){
        for (var j = 0; j < colors_to_target.length; j++){
          var distance = color_distance(colors_to_allocate[i], colors_to_target[j]);
          if (distance < best_distance){
            best_distance = distance;
            best_pair = [colors_to_allocate[i], colors_to_target[j]];
          }
        }
       }
       //remove best_match from colors_to_allocate
       colors_to_allocate.splice(colors_to_allocate.indexOf(best_pair[0]), 1);   
       colors_to_target.splice(colors_to_target.indexOf(best_pair[1]), 1);
       mapping[palettea.indexOf(best_pair[0])] = paletteb.indexOf(best_pair[1]);
      }
      return mapping;
    }

    function apply_state_mapping(mapping){
      for (var i = 0; i < canvasses.length; i++){
        for (var j = 0; j < canvasses[i].length; j++){
          canvasses[i][j] = mapping[canvasses[i][j]];
        }
      }
      var old_hyperlinks = hyperlinks;
      hyperlinks = new Array(16).fill([]);
      for (var page_idx = 0; page_idx < old_hyperlinks.length; page_idx++){
        var page_links = new Array(16).fill(0);
        var page_links_old = old_hyperlinks[page_idx];
        for (var color_idx = 0; color_idx < page_links_old.length; color_idx++){
          page_links[mapping[color_idx]] = page_links_old[color_idx];
        }
        hyperlinks[page_idx] = page_links;
      }

    }

    function transform_state(palette_before, palette_after){
      //need to transform canvasses and hyperlinks to the new palette.
      var mapping = find_palette_transformation(palette_before, palette_after);
      apply_state_mapping(mapping);
      
      //transform background_color      
      var new_background_color = nearest_color_in_palette(palette_after, background_color);  
      changeBackgroundColor(new_background_color);
    }

    var background_colors = {};
    //for each color-palette, find the darkest color and use it as the background color.
    for (var paletteName in palettes) {
      var palette = palettes[paletteName];
      var darkest_color = nearest_color_in_palette(palette,"#000000");
      background_colors[paletteName] = darkest_color;
    }

    //dawnbringer
    //http://www.pixeljoint.com/forum/forum_posts.asp?TID=12795
    var colorPalette = [
      "#140c1c",
      "#442434",
      "#30346d",
      "#4e4a4e",
      "#854c30",
      "#346524",
      "#d04648",
      "#757161",
      "#597dce",
      "#d27d2c",
      "#8595a1",
      "#6daa2c",
      "#d2aa99",
      "#6dc2ca",
      "#dad45e",
      "#deeed6"
    ];

    function set_color_palette(name,preserver_undo_state = true){
      // if there is something on the undo stack, let's check if the previous one 
      // was a change of colour palette 
      // so that information doesn't get lost if you're changing palette rapidly
      if (undoList.length > 0){
        var previous_action = undoList[undoList.length - 1];
        if (previous_action.palette_name !== palette_name){
          var old_canvas_index = canvasIndex;
          doUndo();        
          setLayer(old_canvas_index+1,false)
        }
      }
      if (preserver_undo_state){
        preserveUndoState();
      }
      transform_state(colorPalette, palettes[name]);
      colorPalette = palettes[name];
      // Update color swatches
      for (var i = 0; i < 16; i++) {
        document.documentElement.style.setProperty('--col' + i, colorPalette[i]);
      }
      //need to set all the link-dropdowns to reflect the hyperlinks
      setDropdowns();
      palette_name = name;
    }

    function revert_color_palette_to(p_name){
      var old_palette = palettes[p_name];
      var newer_palette = palettes[palette_name];   
      var mapping = find_palette_transformation(old_palette, newer_palette);
      //invert the mapping
      var inverted_mapping = {};
      for (var key in mapping) {
        inverted_mapping[mapping[key]] = key;
      }
      apply_state_mapping(inverted_mapping);
      palette_name = p_name;
      palette = palettes[p_name];
    }

    var modal = null;
    function openPaletteSelector(){
      if (modal!==null){
        var palette_button = document.getElementById('palette_button');
        palette_button.style.filter = '';
        //webkit also
        palette_button.style.webkitFilter = '';
        
        document.body.removeChild(modal);
        modal=null;
        return;
      }
      // Create a modal dialog
      modal = document.createElement('div');
      modal.className = 'palette-modal';
      

      
      // Create grid container
      var grid = document.createElement('div');
      grid.style.display = 'grid';
      grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
      grid.style.gap = '10px';
      
      // Add all palette previews
      for (var paletteName in palettes) {
        let currently_selected = paletteName === palette_name;
        let paletteDiv = document.createElement('div');
        paletteDiv.style.border = '1px solid gray';
        paletteDiv.style.padding = '5px';
        paletteDiv.style.cursor = 'pointer';
        
        // Add palette name
        let nameDiv = document.createElement('div');
        if (currently_selected){
          nameDiv.textContent = "[ "+paletteName+" ]";
          nameDiv.style.color = 'white';
        } else {          
          nameDiv.textContent = paletteName;
        }
        nameDiv.style.marginBottom = '5px';
        nameDiv.style.textAlign = 'center';
        nameDiv.id = 'palette_name_' + Object.keys(palettes).indexOf(paletteName);
        paletteDiv.appendChild(nameDiv);
        
        // Add color previews
        let colorsDiv = document.createElement('div');
        colorsDiv.style.display = 'grid';
        colorsDiv.style.gridTemplateColumns = 'repeat(8, 1fr)';
        colorsDiv.style.gap = '2px';
        
        palettes[paletteName].forEach(function(color) {
          let colorDiv = document.createElement('div');
          colorDiv.style.width = '100%';
          colorDiv.style.paddingTop = '100%';
          colorDiv.style.backgroundColor = color;
          colorsDiv.appendChild(colorDiv);
        });
        
        paletteDiv.appendChild(colorsDiv);
        
        // Add click handler with proper closure
        (function(name) {
          paletteDiv.onclick = function() {
            if (name === palette_name){
              return;
            }            
            //update nameDiv for previous and new item
            let old_palette_index = Object.keys(palettes).indexOf(palette_name);
            let new_palette_index = Object.keys(palettes).indexOf(name);
            let old_name_div = document.getElementById('palette_name_' + old_palette_index);
            let new_name_div = document.getElementById('palette_name_' + new_palette_index);
            old_name_div.textContent = palette_name;
            old_name_div.style.color = 'gray';
            new_name_div.textContent = "[ "+name+" ]";
            new_name_div.style.color = 'white';

            set_color_palette(name);            
            setVisuals(true);
          };
        })(paletteName);
        
        grid.appendChild(paletteDiv);
      }
      
      // Add elements to modal
      modal.appendChild(grid);
      
      // Add modal to body
      document.body.appendChild(modal);
      //invert color of #palette_button using a transform
      var palette_button = document.getElementById('palette_button');
      palette_button.style.filter = 'invert(1)';
      //webkit also
      palette_button.style.webkitFilter = 'invert(1)';
    }
    
    var colorElem = new Array();
    var layerElem = new Array();
    var colorIndex = getRandomInt(7, 16);

    var aurl = document.createElement('a');
    function qualifyURL(url) {
      aurl.href = url;
      return aurl.href;
    }


    var radiusElem = new Array();
    var thumbnailCanvas = new Array();
    var thumbnailContext = new Array();
    var dropdownOption = new Array();

    var standalone_HTML_String = "";

    var clientStandaloneRequest = new XMLHttpRequest();

    clientStandaloneRequest.open('GET', 'play.html');
    clientStandaloneRequest.onreadystatechange = function () {

      if (clientStandaloneRequest.readyState != 4) {
        return;
      }
      standalone_HTML_String = clientStandaloneRequest.responseText;
    }
    clientStandaloneRequest.send();


    var get_blob = function () {
      return self.Blob;
    }


    function buildStandalone(sourceCode) {
      if (standalone_HTML_String.length === 0) {
        alert("Can't export yet - still downloading html template.", true);
        return;
      }
      sourceCode = encodeURI(sourceCode);
      var htmlString = standalone_HTML_String.concat("");


      htmlString = "<!--Save as html file-->\n " +htmlString;
      htmlString = htmlString.replace(/__EMBED__/g, sourceCode);

      var BB = get_blob();
      var blob = new BB([htmlString], { type: "text/html;charset=utf-8" });
      saveAs(blob, "flickgame.html");
    }

    function exportClick() {
      var embedDat = stateToString();
      buildStandalone(embedDat);
    }

    function importClick() {
      var reader = new FileReader();

      reader.onload = function (e) {
        var text = reader.result;
      }

      reader.readAsText(file, encoding);
    }

    OAUTH_CLIENT_ID = "eb2aad12c63aec0136b1";


    function getAuthURL() {
      var randomState = window.btoa(Array.prototype.map.call(
        window.crypto.getRandomValues(new Uint8Array(24)),
        function (x) { return String.fromCharCode(x); }).join(""));

      var authUrl = "https://github.com/login/oauth/authorize"
        + "?client_id=" + OAUTH_CLIENT_ID
        + "&scope=gist"
        + "&state=" + randomState
        + "&allow_signup=true";

      return authUrl;
    }

    function printUnauthorized() {

      var authUrl = getAuthURL();
      var toPrint = "<a target=\"_blank\" href=\"" + authUrl + "\">Log in with Github to share</a><br>";

      var shareLink = document.getElementById("shareLink");
      shareLink.innerHTML = toPrint;
      shareLinkInner = null;
    }



    function githubLogOut() {
      window.localStorage.removeItem("oauth_access_token");
      var authUrl = getAuthURL();
      var toPrint = "Logged out of Github.<br>";
      var shareLink = document.getElementById("shareLink");
      shareLink.innerHTML = toPrint;
      shareLinkInner = null;
    }


    function shareClick() {
      var oauthAccessToken = window.localStorage.getItem("oauth_access_token");
      if (typeof oauthAccessToken !== "string") {
        // Generates 32 letters of random data, like "liVsr/e+luK9tC02fUob75zEKaL4VpQn".
        printUnauthorized();
        return;
      }


      var str = stateToString();

      var gistToCreate = {
        "description": "flickgame",
        "public": true,
        "files": {
          "readme.txt": {
            "content": "A game made with www.flickgame.org.  You can import game.txt there to play the game.  Uh, too lazy to describe - HMU at analytic@gmail.com if you want to know how (basically just use the gist ID in the url like other flickgames do...) "
          },
          "game.txt": {
            "content": str
          }
        }
      };

      var githubURL = 'https://api.github.com/gists';
      var githubHTTPClient = new XMLHttpRequest();
      githubHTTPClient.open('POST', githubURL);
      githubHTTPClient.onreadystatechange = function () {
        var errorCount = 0;
        if (githubHTTPClient.readyState != 4) {
          return;
        }
        var result = JSON.parse(githubHTTPClient.responseText);
        if (githubHTTPClient.status === 403) {
          errorCount++;
          alert(result.message);
        } else if (githubHTTPClient.status !== 200 && githubHTTPClient.status !== 201) {

          if (githubHTTPClient.statusText === "Unauthorized") {
            alert("Authorization check failed.  You have to log back into GitHub (or give it permission again or something).");
            window.localStorage.removeItem("oauth_access_token");
          } else {
            alert("HTTP Error " + githubHTTPClient.status + ' - ' + githubHTTPClient.statusText);
          }

          printUnauthorized();
        } else if (githubHTTPClient.status !== 200 && githubHTTPClient.status !== 201) {
          errorCount++;
          alert("HTTP Error " + githubHTTPClient.status + ' - ' + githubHTTPClient.statusText);
        } else {
          var id = result.id;
          var url = "play.html?p=" + id;
          url = qualifyURL(url);

          var editurl = "editor.html?hack=" + id;
          editurl = qualifyURL(editurl);
          var sourceCodeLink = "link to source code:<br><a href=\"" + editurl + "\">" + editurl + "</a>";

          var shareLink = document.getElementById("shareLink");
          shareLink.innerHTML = "<a target=\"_blank\" href=\"" + url + "\">&#8627;" + id + "</a><br>" +
            '(<a onclick="githubLogOut();"  href="javascript:void(0);">log out of GitHub</a>)<br>';
          shareLinkInner = shareLink.childNodes[0];

          if (errorCount > 0) {
            alert("Cannot link directly to playable game, because there are errors.", true);
          } else {

          }


        }
      }
      githubHTTPClient.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      githubHTTPClient.setRequestHeader("Authorization", "token " + oauthAccessToken);
      var stringifiedGist = JSON.stringify(gistToCreate);
      githubHTTPClient.send(stringifiedGist);
      lastDownTarget = canvas;
    }

    function RLE_encode(input) {
      var encoding = [];
      var prev, count, i;
      for (count = 1, prev = input[0], i = 1; i < input.length; i++) {
        if (input[i] != prev) {
          encoding.push(count);
          encoding.push(prev);
          count = 1;
          prev = input[i];
        }
        else
          count++;
      }
      encoding.push(count);
      encoding.push(prev);
      return encoding;
    }

    function RLE_decode(encoded) {
      var output = "";
      encoded.forEach(function (pair) { output += new Array(1 + pair[0]).join(pair[1]) })
      return output;
    }

    function stateToString() {
      var state = new Object();
      state.gameLink = gameLink;
      state.activeIndex = canvasIndex;
      state.canvasses = new Array();
      state.palette_name = palette_name;
      for (var i = 0; i < 16; i++) {
        var canvas = canvasses[i];
        var s = "";
        for (var j = 0; j < width * height; j++) {
          s += canvas[j].toString(16);
        }
        var pairs = RLE_encode(s);
        state.canvasses.push(pairs);
      }
      state.hyperlinks = hyperlinks;
      var result = JSON.stringify(state);
      return result;
    }

    function stringToState(str) {
      var state = JSON.parse(str);
      gameLink = state.gameLink;
      canvasIndex = state.activeIndex;
      canvasses = new Array();
      for (var k = 0; k < state.canvasses.length; k++) {
        var s = state.canvasses[k];
        var ar = new Uint8Array(width * height);
        var index = 0;
        for (var i = 0; i < s.length; i += 2) {
          var count = s[i];
          var ch = s[i + 1];
          for (var j = 0; j < count; j++) {
            ar[index] = parseInt(ch, 16);
            index++;
          }
        }
        canvasses.push(ar);
      }
      hyperlinks = state.hyperlinks;

      //if palette_name not defined, set it to dawnbringer-16
      if (state.palette_name === undefined){
        state.palette_name = "dawnbringer-16";
      }
      palette_name = state.palette_name;
    }

    document.addEventListener("keydown", press);
    document.addEventListener("keyup", release);

    var copyImage = null;
    var copyLinks = null;

    var savedString;
    function press(evt) {
      evt = evt || window.event;

      updateCursor(evt);
      /*
      if (evt.keyCode==83){//S(ave)
        savedString = stateToString();
      } else if (evt.keyCode==76){//L(oad)
        stringToState(savedString);
        setVisuals();
        setLayer(canvasIndex+1); 
      } */
      if (evt.keyCode === 67) { //c
        doCopy();
      } else if (evt.keyCode === 86) { //v
        doPaste();
      } else if (evt.keyCode === 189 || evt.keyCode === 173) {//-
        if (radius === 3) {
          setRadius(1);
        } else if (radius === 5) {
          setRadius(3);
        } else if (radius === 7) {
          setRadius(5);
        } else if (radius === 9) {
          setRadius(7);
        } else if (radius === 11) {
          setRadius(9);
        } else if (radius === 13) {
          setRadius(11);
        } else if (radius === 16) {
          setRadius(13);
        }
      } else if (evt.keyCode === 187 || evt.keyCode === 61) {//+
        if (radius === 0) {
          setRadius(1);
        } else if (radius === 1) {
          setRadius(3);
        } else if (radius === 3) {
          setRadius(5);
        } else if (radius === 5) {
          setRadius(7);
        } else if (radius === 7) {
          setRadius(9);
        } else if (radius === 9) {
          setRadius(11);
        } else if (radius === 11) {
          setRadius(13);
        } else if (radius === 13) {
          setRadius(16);
        }
      } else if (evt.keyCode === 90) {//z
        doUndo();
      }
    }

    function release(evt) {
      updateCursor(evt);
    }

    function doUndo() {
      if (undoList.length > 0) {
        var dat = undoList.pop();
        if (dat.palette_name!==palette_name){
          //then we need to change the color palette of ALL canvasses
          revert_color_palette_to(dat.palette_name); 
          setVisuals(true);
          return;    
        }
        canvasses[dat.canvasIndex] = dat.canvasDat;        
        colorPalette = palettes[palette_name];
        if (background_color !== dat.background_color){
          changeBackgroundColor(dat.background_color,false);
        }
        setLayer(dat.canvasIndex + 1,true);

        if (shareLinkInner !== null) {
          shareLinkInner.style.color = "gray";
        }
      }
    }

    function doCopy() {
      copyImage = JSON.stringify(canvasses[canvasIndex])
      copyLinks = JSON.stringify(hyperlinks[canvasIndex])
    }

    function doPaste() {
      if (copyImage !== null) {
        preserveUndoState();
        var ar = JSON.parse(copyImage);
        var arui8 = new Uint8Array(width * height);
        for (var i = 0; i < width * height; i++) {
          arui8[i] = ar[i];
        }
        canvasses[canvasIndex] = arui8;
        hyperlinks[canvasIndex] = JSON.parse(copyLinks);
        setVisuals();
        setDropdowns();
      }
    }

    function setDropdowns() {
      for (var i = 0; i < 16; i++) {
        dropdownOption[i].value = hyperlinks[canvasIndex][i];
      }
    }

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min)) + min;
    }
    var width = 160;
    var height = 100;
    var zoomFactor = 4;
    var radius = 5;

    var visibleCanvas;
    var visibleContext;
    var linkInput;
    var id;
    var id_d;

    var lastX = -1;
    var lastY = -1;
    var lastButton = -1

    var bucketElem;

    function linkChange(newLink) {
      gameLink = newLink;
    }

    function clearPalette() {
      preserveUndoState();
      var canvas = canvasses[canvasIndex];
      for (var i = 0; i < width * height; i++) {
        canvas[i] = 0;
      }

      setVisuals();
    }
    function setRadius(newRadius) {
      radius = newRadius;
      bucketElem.setAttribute("class", "radius");
      for (var i = 0; i < 16; i++) {
        if (radiusElem[i] !== null) {
          radiusElem[i].setAttribute("class", "radius");
        }
      }
      if (newRadius > 0) {
        radiusElem[newRadius - 1].setAttribute("class", "radius selected");
      } else {
        bucketElem.setAttribute("class", "radius selected");
      }
    }


    function dropDownSelect(dropdown, val) {
      hyperlinks[canvasIndex][dropdown - 1] = parseInt(val);
    }

    function setColor(newColorIndex) {
      colorIndex = newColorIndex;
      for (var i = 0; i < 16; i++) {
        if (colorElem[i] !== null) {
          colorElem[i].setAttribute("class", "unselected");
        }
      }
      colorElem[colorIndex].setAttribute("class", "selected");
    }

    function setLayer(newCanvasIndex,force_gen_thumbnails=false) {
      canvasIndex = newCanvasIndex - 1;
      for (var i = 0; i < 16; i++) {
        if (layerElem[i] !== null) {
          layerElem[i].setAttribute("class", "layerItem");
        }
      }
      layerElem[canvasIndex].setAttribute("class", "layerItem selectedItem");
      setVisuals(force_gen_thumbnails);
      setDropdowns();
    }

    function generateDropDowns(){
       // Add this at the start of the init function
      // Generate dropdown options
      for (let i = 1; i <= 16; i++) {
        const select = document.getElementById(`col${i}`);
        for (let j = 1; j <= 16; j++) {
          const option = document.createElement('option');
          option.value = j;
          option.id = `col${i}-${j}`;
          option.textContent = j;
          select.appendChild(option);
        }
      }
    }

    function init() {
      generateDropDowns();

      // Populate background color dropdown
      var bgColorSelect = document.getElementById('bgColorSelect');
      for (var i = 0; i < colorPalette.length; i++) {
        var option = document.createElement('option');
        option.value = colorPalette[i];
        option.textContent = "";
        option.style.backgroundColor = "var(--col" + i + ")";
        bgColorSelect.appendChild(option);
      }
      // Set initial background color
      bgColorSelect.value = colorPalette[0];

      linkInput = document.getElementById("linkInput");
      linkInput.value = gameLink;


      radii = new Array();
      for (var i = 0; i < 16; i++) {
        elem = document.getElementById("radius_" + (i + 1));
        radiusElem[i] = elem;

      }

      for (var i = 0; i < 16; i++) {
        elem = document.getElementById("thumbnail" + (i + 1));
        thumbnailCanvas[i] = elem;
        thumbnailContext[i] = elem.getContext("2d");
      }
      for (var i = 0; i < 16; i++) {
        elem = document.getElementById("col" + (i + 1));
        dropdownOption[i] = elem;
      }

      for (var i = 0; i < 16; i++) {
        elem = document.getElementById("color_" + (i));
        elem.style.backgroundColor = "var(--col" + i + ")";
        colorElem[i] = elem;
      }

      for (var i = 0; i < 16; i++) {
        elem = document.getElementById("layerItem" + (i + 1));
        layerElem[i] = elem;
      }


      bucketElem = document.getElementById("bucket");


      for (var i = 0; i < 16; i++) {
        canvasses[i] = new Uint8Array(width * height);
      }

      for (var i = 0; i < 16; i++) {
        hyperlinks[i] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
      }

      visibleCanvas = document.getElementById("mainCanvas");
      visibleCanvas.addEventListener('pointerdown', mouseDown, false);
      visibleCanvas.addEventListener('pointerup', mouseUp, false);
      visibleCanvas.addEventListener('pointermove', mouseMove, false);
      visibleCanvas.addEventListener('pointerout', mouseOut, false);
      visibleCanvas.addEventListener('pointerleave', mouseOut, false);

      var fileUploader = document.getElementById("my_file");
      fileUploader.addEventListener('change', readFile, false);

      window.addEventListener('mouseup', mouseUp, false);    

      visibleContext = visibleCanvas.getContext("2d");
      visibleContext.imageSmoothingEnabled = false;
      id = visibleContext.createImageData(1, 1); // only do this once per page
      id_d = id.data;
      setVisuals(true);
      setColor(colorIndex);


      getData();
    }

    function readFile(evt) {
      //Retrieve the first (and only!) File from the FileList object
      var f = evt.target.files[0];

      if (f) {
        var r = new FileReader();
        r.onload = function (e) {
          var contents = e.target.result;
          var fromToken = "<!--__EmbedBegin__-->";
          var endToken = "<!--__EmbedEnd__-->";
          var fromIndex = contents.indexOf(fromToken);
          var endIndex = contents.indexOf(endToken);
          var ss1 = contents.substr(fromIndex + fromToken.length, endIndex - fromIndex - fromToken.length);
          var ss2 = ss1.substr(ss1.indexOf("=") + 2);
          var decoded = decodeURI(ss2);
          var decoded2 = decoded.substring(0, decoded.length - 3);
          stringToState(decoded2);
          setVisuals(true);
          setLayer(canvasIndex + 1);
        }
        r.readAsText(f);
      } else {
        alert("Failed to load file");
      }
    }



    function getParameterByName(name) {
      name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
      return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }


    function strip_http(url) {
      url = url.replace(/^https?:\/\//, '');
      return url;
    }

    function getData() {
      var id = getParameterByName("p").replace(/[\\\/]/, "");
      if (id === null || id.length === 0) {

        return;
      }

      var githubURL = 'https://api.github.com/gists/' + id;

      var githubHTTPClient = new XMLHttpRequest();
      githubHTTPClient.open('GET', githubURL);
      githubHTTPClient.onreadystatechange = function () {
        if (githubHTTPClient.readyState != 4) {
          return;
        }
        var result = JSON.parse(githubHTTPClient.responseText);
        if (githubHTTPClient.status === 403) {
          alert(result.message);
        } else if (githubHTTPClient.status !== 200 && githubHTTPClient.status !== 201) {
          alert("HTTP Error " + githubHTTPClient.status + ' - ' + githubHTTPClient.statusText);
        }
        var result = JSON.parse(githubHTTPClient.responseText);
        var code = result["files"]["game.txt"]["content"];

        stringToState(code);
        setVisuals(true);
        setLayer(canvasIndex + 1);
      }
      githubHTTPClient.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      githubHTTPClient.send();
    }


    function drawThumbnail(n) {
      thumbCtx = thumbnailContext[n];
      thumbCtx.fillStyle = "#FF0000";
      thumbCtx.fillRect(0, 0, 16, 10);
      var canvas = canvasses[n];
      for (var i = 0; i < 16; i++) {
        for (var j = 0; j < 10; j++) {
          var max = 0;
          for (var i2 = 0; i2 < 10; i2++) {
            for (var j2 = 0; j2 < 10; j2++) {
              var sample = canvas[i * 10 + i2 + width * (j * 10 + j2)];
              if (sample > max) {
                max = sample;
              }
            }
          }
          thumbCtx.fillStyle = colorPalette[max];
          thumbCtx.fillRect(i, j, 1, 1);
        }
      }

      //      var dataUrl = thumbnailCanvas[n].toDataURL();
      //      "dropdownOption"[0][0].style.backgroundImage="url("+dataUrl+")";
    }

    function setVisuals(genAllThumbnails=false) {
      //visibleContext.drawImage(canvasses[canvasIndex], 0, 0); 
      //visibleContext.drawImage(canvasses[canvasIndex], 0, 0,width*zoomFactor,height*zoomFactor); 
      canvas = canvasses[canvasIndex];
      for (var i = 0; i < width; i++) {
        for (var j = 0; j < height; j++) {
          var pixelIndex = canvas[i + width * j];
          visibleContext.fillStyle = colorPalette[pixelIndex];
          visibleContext.fillRect(i * zoomFactor, j * zoomFactor, zoomFactor, zoomFactor);
        }
      }
      if (genAllThumbnails === true) {
        for (var i = 0; i < 16; i++) {
          drawThumbnail(i);
        }
      } else {
        drawThumbnail(canvasIndex);
      }
      linkInput.value = gameLink;
      //set body background
      // document.body.style.backgroundColor = background_colors[palette_name];
    }


    var drawing = 0;


    function getCoords(e) {
      var x, y;
      if (typeof e.offsetX !== "undefined") {
        x = e.offsetX;
        y = e.offsetY;
      }
      else if (e.touches !== null) {
        if (e.touches.length === 0) {
          return null;
        }
        var target = e.target || e.srcElement;
        var rect = target.getBoundingClientRect();

        x = 0;
        y = 0;
        for (var i = 0; i < e.touches.length; i++) {
          x += e.touches[i].clientX - rect.left;
          y += e.touches[i].clientY - rect.top;
        }
        x /= e.touches.length;
        y /= e.touches.length;

      } else {
        var target = e.target || e.srcElement;
        var rect = target.getBoundingClientRect();
        x = e.clientX - rect.left,
          y = e.clientY - rect.top;
      }
      return [x, y];
    }



    function uint8ar_copy(src) {
      var dst = new Uint8Array(width * height);
      for (var i = 0; i < src.length; i++) {
        dst[i] = src[i];
      }
      return dst;
    }

    var undoList = new Array();
    function preserveUndoState() {
      var undoItem = new Object();
      undoItem.canvasIndex = canvasIndex;
      undoItem.canvasDat = uint8ar_copy(canvasses[canvasIndex]);
      undoItem.palette_name = palette_name;
      undoItem.background_color = background_color;
      undoList.push(undoItem);
      if (undoList.length > 100) {
        undoList.shift();
      }

      if (shareLinkInner !== null) {
        shareLinkInner.style.color = "gray";
      }
    }

    function mouseDown(e) {
      e = e || window.event;

      drawing = 1;
      var coords = getCoords(e);
      if (coords === null) {
        lastX = -1;
        lastY = -1;
        e.preventDefault();
        return !1;
      }
      startTargetX = coords[0];
      startTargetY = coords[1];
      lastX = Math.floor(startTargetX / zoomFactor);
      lastY = Math.floor(startTargetY / zoomFactor);

      preserveUndoState();


      if (window.onbeforeunload === null) {
        window.onbeforeunload = function () {
          return true;
        };
      }

      mouseMove(e);
      if (radius === 0) {
        drawing = 0;
      }

      e.preventDefault();
      return !1;
    }

    function mouseUp(e) {
      e = e || window.event;

      drawing = 0;
      lastX = -1;
      lastY = -1;
      lastButton = -1;

      e.preventDefault();
    }

    function mouseOut(e) {
      e = e || window.event;
      window.console.log(e);
      mouseMove(e);
      lastX = -1;
      lastY = -1;

      e.preventDefault();
    }


    function line(x1, y1, x2, y2) {
      var coordinatesArray = new Array();
      // Translate coordinates
      // Define differences and error check
      var dx = Math.abs(x2 - x1);
      var dy = Math.abs(y2 - y1);
      var sx = (x1 < x2) ? 1 : -1;
      var sy = (y1 < y2) ? 1 : -1;
      var err = dx - dy;
      // Set first coordinates
      coordinatesArray.push([x1, y1]);
      // Main loop
      while (!((x1 == x2) && (y1 == y2))) {
        var e2 = err << 1;
        if (e2 > -dy) {
          err -= dy;
          x1 += sx;
        }
        if (e2 < dx) {
          err += dx;
          y1 += sy;
        }
        // Set coordinates
        coordinatesArray.push([x1, y1]);
      }
      // Return the result
      return coordinatesArray;
    }

    function updateCursor(e) {
      // Update cursor based on modifier keys
      if (e.metaKey || e.altKey || e.shiftKey || e.ctrlKey || lastButton > 0) {
        mainCanvas.style.cursor = "url('eyedropper.png') 2 16, crosshair";
      } else {
        mainCanvas.style.cursor = "crosshair";
      }

    }

    function updateLastButton(e) {
      if (e.button !== -1) {
        lastButton = e.button;
      }
    }

    function mouseMove(e) {
      e = e || window.event;

      var coords = getCoords(e);
      if (coords === null) {
        lastX = -1;
        lastY = -1;
        e.preventDefault();
        return !1;
      }
      updateLastButton(e);

      updateCursor(e);

      if (drawing === 0)
        return;

      var mousePressure = e.pressure;
      if (e.pointerType !== "pen") {
        mousePressure = 0.5;
      }
      if (mousePressure === 0) {
        //   mouseUp(e);
        return;
      }

      var x = Math.floor(coords[0] / zoomFactor);
      var y = Math.floor(coords[1] / zoomFactor);

      if (e.metaKey || e.altKey || e.shiftKey || e.ctrlKey || lastButton > 0) {

        var pIndex = x + width * y;
        var canvas = canvasses[canvasIndex];
        var newColorIndex = canvas[pIndex];

        // console.log(` x = ${x}; y = ${y}; pIndex = ${pIndex}; newColorIndex = ${newColorIndex}`);
        setColor(newColorIndex);
        e.preventDefault();
        return false;
      }

      var canvas = canvasses[canvasIndex];

      var points;
      if (lastX === -1) {
        points = [[x, y]];
      } else {
        if (x < 0 || y < 0) {
          console.log("NEGATIVE TIME");
          console.log(e);
        }
        points = line(x, y, lastX, lastY);
      }

      for (var i = 0; i < points.length; i++) {
        var p = points[i];

        if (radius > 0) {
          var r = radius * (mousePressure * 2);
          drawCircle(canvas, p[0], p[1], r, colorIndex);
        } else {
          floodFill(canvas, p[0], p[1], colorIndex);
        }
      }


      /*context.beginPath();
      context.arc(x, y, radius, 0, 2 * Math.PI, false);
      context.lineWidth = 0;
      context.fillStyle = 'green';
      context.fill();*/
      setVisuals();

      var coords = getCoords(e);
      if (coords === null) {
        lastX = -1;
        lastY = -1;
        e.preventDefault();
        return !1;
      }
      lastX = Math.floor(coords[0] / zoomFactor);
      lastY = Math.floor(coords[1] / zoomFactor);

    }

    function drawCircle(canvas, x, y, radius, colorIndex) {
      radius = Math.floor(radius / 2) + 1;
      if (radius == 2) {
        var points = [[x, y], [x - 1, y], [x, y + 1], [x + 1, y], [x, y - 1]];
        for (var i = 0; i < points.length; i++) {
          var px = points[i][0];
          var py = points[i][1];
          if (px >= 0 && px < 160 && py >= 0 && py < 100) {
            canvas[px + width * py] = colorIndex;
          }
        }
        return;
      } else if (radius == 3) {
        var points = [
          [x - 1, y + 2], [x, y + 2], [x + 1, y + 2],
          [x - 2, y + 1], [x - 1, y + 1], [x, y + 1], [x + 1, y + 1], [x + 2, y + 1],
          [x - 2, y], [x - 1, y], [x, y], [x + 1, y], [x + 2, y],
          [x - 2, y - 1], [x - 1, y - 1], [x, y - 1], [x + 1, y - 1], [x + 2, y - 1],
          [x - 1, y - 2], [x, y - 2], [x + 1, y - 2]
        ];
        for (var i = 0; i < points.length; i++) {
          var px = points[i][0];
          var py = points[i][1];
          if (px >= 0 && px < 160 && py >= 0 && py < 100) {
            canvas[px + width * py] = colorIndex;
          }
        }
        return;

      }

      for (var i = Math.max(x - radius, 0); i <= Math.min(x + radius, width - 1); i++) {
        for (var j = Math.max(y - radius, 0); j <= Math.min(y + radius, height - 1); j++) {
          var dx = i - x;
          var dy = j - y;
          if ((dx * dx + dy * dy) < radius * radius) {
            canvas[i + width * j] = colorIndex;
          }
        }
      }
    }

    function floodFill(canvas, x, y, colorIndex) {
      var points = [[x, y]];
      originColor = canvas[x + width * y];
      if (originColor === colorIndex) {
        return;
      }

      for (var i = 0; i < points.length; i++) {
        var p = points[i];
        var pIndex = p[0] + width * p[1];
        if (canvas[pIndex] === colorIndex) {
          continue;
        } else {
          canvas[pIndex] = colorIndex;
          borderPoints = [[p[0] + 1, p[1]], [p[0] - 1, p[1]], [p[0], p[1] + 1], [p[0], p[1] - 1]];
          for (var j = 0; j < borderPoints.length; j++) {
            var borderPoint = borderPoints[j];
            var bpx = borderPoint[0];
            var bpy = borderPoint[1];
            var bpi = bpx + width * bpy;
            if (
              bpx >= 0 &&
              bpx < width &&
              bpy >= 0 &&
              bpy < height &&
              canvas[bpi] === originColor) {
              points.push([bpx, bpy]);
            }
          }
        }
      }
    }

    function toolbar_undo() {
      doUndo();
    }
    function toolbar_copy() {
      doCopy();
    }
    function toolbar_paste() {
      doPaste();
    }

    function changeBackgroundColor(color,preserver_undo_state = false) {
      if (color === undefined) {
        console.log("color is undefined");
        color = colorPalette[0];
      }
      if (background_color===color){
        console.log("background_color is already set to same color");
        return;
      }
      if (preserver_undo_state){
        preserveUndoState();
      }
      background_color = color;
      document.body.style.backgroundColor = color;
      var distance_from_white = color_distance(color, "#ffffff");
      var distance_from_black = color_distance(color, "#000000");
      if (distance_from_white < distance_from_black){
        foreground_color = "#000000";
        document.documentElement.style.setProperty('--foreground-color', "#000000");
        document.documentElement.style.setProperty('--radius-filter', 'invert(1)');
        document.documentElement.style.setProperty('--selected-border-color', '#00ffff');
      } else {
        foreground_color = "#ffffff";
        document.documentElement.style.setProperty('--foreground-color', "#ffffff");
        document.documentElement.style.setProperty('--radius-filter', 'none');
        document.documentElement.style.setProperty('--selected-border-color', '#ff0000');
      }
      //get bgColorSelect
      var bgColorSelect = document.getElementById('bgColorSelect');
      bgColorSelect.style.backgroundColor = background_color;
    }
  </script>

  <style type="text/css">
    /*<![CDATA[*/

    /* foreground text color variable*/
  :root {
    --foreground-color: white;
    --radius-filter: none;
    --selected-border-color: #ff0000;

    --col0:#140c1c;
    --col1:#442434;
    --col2:#30346d;
    --col3:#4e4a4e;
    --col4:#854c30;
    --col5:#346524;
    --col6:#d04648;
    --col7:#757161;
    --col8:#597dce;
    --col9:#d27d2c;
    --col10:#8595a1;
    --col11:#6daa2c;
    --col12:#d2aa99;
    --col13:#6dc2ca;
    --col14:#dad45e;
    --col15:#deeed6;
  }
  
    #maincanvas {
      cursor: crosshair;
      image-rendering: optimizeSpeed;
      image-rendering: -moz-crisp-edges;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: -o-crisp-edges;
      image-rendering: pixelated;
      -ms-interpolation-mode: nearest-neighbor;
    }

    /* Add new styles for palette modal */
    .palette-modal {
      position: fixed;
      max-width: 220px;
      max-height: 400px;
      overflow-y: auto;
      top: 20px;
      right:0;
      background-color: black;
      border: 2px solid gray;
      padding: 25px;
      z-index: 1000;
    }

    @media (min-width: 1400px) {
      .palette-modal {
        right:unset;
        left: 50%;
        transform: translate(calc(50% + 300px), 0);
      }
    }


    select {
      background-color: black;
      color: white;
      text-indent: 5px;
    }

    canvas {
      position: relative;
    }

    body {
      background-color: black;
      color: gray;
      margin-top: 0;
      padding-top: 0;
      border-top: 0;
    }

    ul {
      list-style-type: none;
      overflow: hidden;
      overflow-y: auto;
    }

    input {
      background-color: black;
      color: white;
      font-size: 200%;
      text-align: center;
      margin-bottom: 5px;
    }

    input#linkInput {
      background-color: black;
      color: white;
      font-size: 150%;
      text-align: center;
      margin-bottom: 5px;
      padding-bottom: 3px;
      /*inlin*/
      display: inline;
    }
    #bgColorSelect {
      display:inline;
      width:50px;
    }
    li {
      font-size: 150%;
      text-align: center;
      width: 100%;
    }

    a {
      color: var(--foreground-color);
    }

    a.layerItem {
      color: var(--foreground-color);
      background-color: transparent;
      text-decoration: none;
      width: 100%;
      display: block;
    }

    a.layerItem.selectedItem {
      color: black;
      background-color: white;
    }

    /*all images pixelated*/
    img {
      image-rendering: pixelated;
    }

    img.selected {
      border: 2px solid var(--selected-border-color);
      touch-action: manipulation;
    }

    li.selected {
      cursor: auto;
      color: white;
    }

    a {
      white-space: nowrap;
      touch-action: manipulation;
    }

    div.selected {
      height: 16px;
      width: 30px;
      border: 2px solid var(--selected-border-color);
      touch-action: manipulation;
    }

    div.unselected {
      height: 16px;
      width: 30px;
      border: 2px solid black;
      touch-action: manipulation;
    }

    img.radius {
      border: 1px solid transparent;
      touch-action: manipulation;
      filter: var(--radius-filter);
    }

    img.toolbar {
      width: 30px;
      height: 30px;
      background-color: transparent;
      color: white;
      font-size: 200%;
      text-align: center;
      margin-bottom: 5px;
      touch-action: manipulation;
    }

    #toolbarcontainer {
      float: right;
      margin-right: 20px;
      margin-top: 5px;
      touch-action: manipulation;
    }

    img.selected {
      border: 1px solid var(--selected-border-color);
    }

    select {
      width: 100%;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    select::-ms-expand {
      display: none;
    }

    canvas#dropdownthumb {
      border: 2px solid gray;
      background-color: black;
      touch-action: manipulation;
    }

    
    #bgColorSelect{
      height: 30px;
      margin-left: 50px;
    }
    /*  overlay bgColorSelectContainer with floating text "BG", centered over the
      preceeding span.
    */
    #bgColorSelectContainer::after {
      content: "BG";
      color: var(--foreground-color);
      position: relative;      
      left:-33px;
      /*don't capture input!*/
      pointer-events: none;
    }

    /*]]>*/
  </style>
  <title>
    flickgame.org
  </title>
</head>

<body onload="init();" ondragstart="return false;" ondrop="return false;">
  <center>
    <table cellpadding="10">
      <tr>
        <td>
          <ul>
            <li>
              <a class="layerItem selectedItem" id="layerItem1" href="#" onclick="setLayer(1);return false;">
                <canvas id="thumbnail1" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                1</a>
            </li>
            <li>
              <a class="layerItem" id="layerItem2" href="#" onclick="setLayer(2);return false;">
                <canvas id="thumbnail2" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                2</a>
            </li>
            <li>
              <a class="layerItem" id="layerItem3" href="#" onclick="setLayer(3);return false;">
                <canvas id="thumbnail3" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                3</a>
            </li>
            <li>
              <a class="layerItem" id="layerItem4" href="#" onclick="setLayer(4);return false;">
                <canvas id="thumbnail4" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                4</a>
            </li>
            <li>
              <a class="layerItem" id="layerItem5" href="#" onclick="setLayer(5);return false;">
                <canvas id="thumbnail5" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                5</a>
            </li>
            <li>
              <a class="layerItem" id="layerItem6" href="#" onclick="setLayer(6);return false;">
                <canvas id="thumbnail6" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                6</a>
            </li>
            <li>
              <a class="layerItem" id="layerItem7" href="#" onclick="setLayer(7);return false;">
                <canvas id="thumbnail7" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                7</a>
            </li>
            <li>
              <a class="layerItem" id="layerItem8" href="#" onclick="setLayer(8);return false;">
                <canvas id="thumbnail8" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                8</a>
            </li>
            <li>
              <a class="layerItem" id="layerItem9" href="#" onclick="setLayer(9);return false;">
                <canvas id="thumbnail9" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                9</a>
            </li>
            <li>
              <a class="layerItem" id="layerItem10" href="#" onclick="setLayer(10);return false;">
                <canvas id="thumbnail10" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                10</a>
            </li>
            <li>
              <a class="layerItem" id="layerItem11" href="#" onclick="setLayer(11);return false;">
                <canvas id="thumbnail11" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                11</a>
            </li>
            <li>
              <a class="layerItem" id="layerItem12" href="#" onclick="setLayer(12);return false;">
                <canvas id="thumbnail12" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                12</a>
            </li>
            <li>
              <a class="layerItem" id="layerItem13" href="#" onclick="setLayer(13);return false;">
                <canvas id="thumbnail13" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                13</a>
            </li>
            <li>
              <a class="layerItem" id="layerItem14" href="#" onclick="setLayer(14);return false;">
                <canvas id="thumbnail14" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                14</a>
            </li>
            <li>
              <a class="layerItem" id="layerItem15" href="#" onclick="setLayer(15);return false;">
                <canvas id="thumbnail15" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                15</a>
            </li>
            <li>
              <a class="layerItem" id="layerItem16" href="#" onclick="setLayer(16);return false;">
                <canvas id="thumbnail16" width="16" height="10"
                  style="border:2px solid gray; background-color:transparent;"></canvas>
                16</a>
            </li>
          </ul>
        </td>
        <td valign="top">
          <table>
            <tr>
              <td>
                <table>
                  <tr>
                    <td>
                      <center>
                        <input width="640" style="border:2px solid gray;" onkeydown="event.stopPropagation();"
                          value="www.flickgame.org" id="linkInput" oninput="linkChange(this.value)" />
                          <span id="bgColorSelectContainer"><select id="bgColorSelect" class="toolbar"  style="border: 2px solid gray;" onchange="changeBackgroundColor(this.value,true);">
                          </select></span>&nbsp;
                        <span id="toolbarcontainer">

                          <a href="#" onclick="toolbar_undo();return false;"><img src="SVG/undo.svg" title="undo (U)"
                              alt="undo" class="toolbar" id="toolbar_undo" /></a>
                          &nbsp;
                          <a href="#" onclick="toolbar_copy();return false;"><img src="SVG/copy.svg"
                              title="copy to clipboard (C)" alt="copy to clipboard" class="toolbar"
                              id="toolbar_copy" /></a>
                          &nbsp;
                          <a href="#" onclick="toolbar_paste();return false;"><img src="SVG/paste.svg"
                              title="paste from clipboard (V)" alt="paste from clipboard" class="toolbar"
                              id="toolbar_paste" /></a>
                        </span>
                        <br />
                      </center>
                        <canvas id="mainCanvas" oncontextmenu="return false;" width="640" height="400"
                          style="border:2px solid gray; background-color:black;"></canvas>
                        <br />
                    </td>
                    <td valign="top">
                      <a href="#" onclick="shareClick();return false;">&ocir; share</a><br />
                      <div id="shareLink"></div>
                      <a href="#" onclick="exportClick();return false;">&sdotb; export</a><br />
                      <a href="#" onclick="document.getElementById('my_file').click();return false;">&sdotb;
                        import</a><br />
                      <input type="file" accept=".html" id="my_file" style="display: none;" />
                      <a href="help.html" target="_blank" title="blah">? help</a>
                      <br />
                      <br />
                      <a href="#" onclick="setRadius(16);return false;"><img src="16.png" class="radius"
                          id="radius_16" /></a>
                      <br />
                      <a href="#" onclick="setRadius(13);return false;"><img src="13.png" class="radius"
                          id="radius_13" /></a>
                      <br />
                      <a href="#" onclick="setRadius(11);return false;"><img src="11.png" class="radius"
                          id="radius_11" /></a>
                      <br />
                      <a href="#" onclick="setRadius(9);return false;"><img src="9.png" class="radius"
                          id="radius_9" /></a>
                      <br />
                      <a href="#" onclick="setRadius(7);return false;"><img src="7.png" class="radius"
                          id="radius_7" /></a>
                      <br />
                      <a href="#" onclick="setRadius(5);return false;"><img src="5.png" class="radius selected"
                          id="radius_5" /></a>
                      <br />
                      <a href="#" onclick="setRadius(3);return false;"><img src="3.png" class="radius"
                          id="radius_3" /></a>
                      <br />
                      <a href="#" onclick="setRadius(1);return false;"><img src="1.png" class="radius"
                          id="radius_1" /></a>
                      <br />
                      <a href="#" onclick="setRadius(0);return false;"><img src="bucket.png" class="radius"
                          id="bucket" /></a>
                      <br />
                      <a href="#" onclick="clearPalette();return false;"><img src="clear.png" class="radius"
                          id="bucket" /></a>
                    </td>
                  </tr>
                </table>
                <table style="border:2px solid gray; margin-top:2px; margin-left:3px;" margin="0">
                  <tr height="16">
                    <td>
                      <a href="#" onclick="setColor(0);return false;">
                        <div class="unselected" id="color_0"></div>
                      </a>
                    </td>
                    <td>
                      <a href="#" onclick="setColor(1);return false;">
                        <div class="unselected" id="color_1"></div>
                      </a>
                    </td>
                    <td>
                      <a href="#" onclick="setColor(2);return false;">
                        <div class="selected" id="color_2"></div>
                      </a>
                    </td>
                    <td>
                      <a href="#" onclick="setColor(3);return false;">
                        <div class="unselected" id="color_3"></div>
                      </a>
                    </td>
                    <td>
                      <a href="#" onclick="setColor(4);return false;">
                        <div class="unselected" id="color_4"></div>
                      </a>
                    </td>
                    <td>
                      <a href="#" onclick="setColor(5);return false;">
                        <div class="unselected" id="color_5"></div>
                      </a>
                    </td>
                    <td>
                      <a href="#" onclick="setColor(6);return false;">
                        <div class="unselected" id="color_6"></div>
                      </a>
                    </td>
                    <td>
                      <a href="#" onclick="setColor(7);return false;">
                        <div class="unselected" id="color_7"></div>
                      </a>
                    </td>
                    <td>
                      <a href="#" onclick="setColor(8);return false;">
                        <div class="unselected" id="color_8"></div>
                      </a>
                    </td>
                    <td>
                      <a href="#" onclick="setColor(9);return false;">
                        <div class="unselected" id="color_9"></div>
                      </a>
                    </td>
                    <td>
                      <a href="#" onclick="setColor(10);return false;">
                        <div class="unselected" id="color_10"></div>
                      </a>
                    </td>
                    <td>
                      <a href="#" onclick="setColor(11);return false;">
                        <div class="unselected" id="color_11"></div>
                      </a>
                    </td>
                    <td>
                      <a href="#" onclick="setColor(12);return false;">
                        <div class="unselected" id="color_12"></div>
                      </a>
                    </td>
                    <td>
                      <a href="#" onclick="setColor(13);return false;">
                        <div class="unselected" id="color_13"></div>
                      </a>
                    </td>
                    <td>
                      <a href="#" onclick="setColor(14);return false;">
                        <div class="unselected" id="color_14"></div>
                      </a>
                    </td>
                    <td>
                      <a href="#" onclick="setColor(15);return false;">
                        <div class="unselected" id="color_15"></div>
                      </a>
                    </td>
                    <!--must have border to left of this td-->
                    <td rowspan="2" style="border-left: 2px solid gray;">
                      <a href="#" onclick="openPaletteSelector();return false;"><img id="palette_button" src="palette.png"></a>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <select id="col1" onchange="dropDownSelect(1,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <td>
                      <select id="col2" onchange="dropDownSelect(2,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <td>
                      <select id="col3" onchange="dropDownSelect(3,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <td>
                      <select id="col4" onchange="dropDownSelect(4,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <td>
                      <select id="col5" onchange="dropDownSelect(5,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <td>
                      <select id="col6" onchange="dropDownSelect(6,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <td>
                      <select id="col7" onchange="dropDownSelect(7,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <td>
                      <select id="col8" onchange="dropDownSelect(8,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <td>
                      <select id="col9" onchange="dropDownSelect(9,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <td>
                      <select id="col10" onchange="dropDownSelect(10,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <td>
                      <select id="col11" onchange="dropDownSelect(11,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <td>
                      <select id="col12" onchange="dropDownSelect(12,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <td>
                      <select id="col13" onchange="dropDownSelect(13,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <td>
                      <select id="col14" onchange="dropDownSelect(14,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <td>
                      <select id="col15" onchange="dropDownSelect(15,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <td>
                      <select id="col16" onchange="dropDownSelect(16,this.value)">
                        <option value="0"></option>
                      </select>
                    </td>
                    <!--color-picker is in the next td, which should resize to fit remaining space-->


                  </tr>
                </table>
                <br />
              </td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
  </center>
</body>

</html>